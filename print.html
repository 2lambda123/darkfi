<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The DarkFi Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">DarkFi</a></li><li class="chapter-item expanded "><a href="IDEOLOGY.html"><strong aria-hidden="true">1.</strong> Ideology</a></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">2.</strong> Development</a></li><li class="chapter-item expanded "><a href="portranges.html"><strong aria-hidden="true">3.</strong> Port ranges</a></li><li class="chapter-item expanded "><a href="architecture/architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="architecture/overview.html"><strong aria-hidden="true">4.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="architecture/layers.html"><strong aria-hidden="true">4.2.</strong> Layers</a></li><li class="chapter-item expanded "><a href="architecture/anonymous_assets.html"><strong aria-hidden="true">4.3.</strong> Anonymous Assets</a></li><li class="chapter-item expanded "><a href="architecture/blockchain.html"><strong aria-hidden="true">4.4.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="architecture/dna.html"><strong aria-hidden="true">4.5.</strong> DNA</a></li><li class="chapter-item expanded "><a href="architecture/smart_contracts.html"><strong aria-hidden="true">4.6.</strong> Smart Contracts</a></li></ol></li><li class="chapter-item expanded "><a href="clients/clients.html"><strong aria-hidden="true">5.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="clients/darkfid_jsonrpc.html"><strong aria-hidden="true">5.1.</strong> darkfid JSON-RPC API</a></li><li class="chapter-item expanded "><a href="clients/cashierd_jsonrpc.html"><strong aria-hidden="true">5.2.</strong> cashierd JSON-RPC API</a></li><li class="chapter-item expanded "><a href="clients/faucetd_jsonrpc.html"><strong aria-hidden="true">5.3.</strong> faucetd JSON-RPC API</a></li></ol></li><li class="chapter-item expanded "><a href="zkas/index.html"><strong aria-hidden="true">6.</strong> zkas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zkas/bincode.html"><strong aria-hidden="true">6.1.</strong> Bincode</a></li><li class="chapter-item expanded "><a href="zkas/examples.html"><strong aria-hidden="true">6.2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zkas/examples/sapling.html"><strong aria-hidden="true">6.2.1.</strong> Sapling scheme</a></li><li class="chapter-item expanded "><a href="zkas/examples/voting.html"><strong aria-hidden="true">6.2.2.</strong> Anonymous voting</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="misc/misc.html"><strong aria-hidden="true">7.</strong> Miscellaneous tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="misc/vanityaddr.html"><strong aria-hidden="true">7.1.</strong> vanityaddr</a></li><li class="chapter-item expanded "><a href="misc/ircd.html"><strong aria-hidden="true">7.2.</strong> ircd</a></li><li class="chapter-item expanded "><a href="misc/tau.html"><strong aria-hidden="true">7.3.</strong> tau</a></li><li class="chapter-item expanded "><a href="misc/hashchain/hashchain.html"><strong aria-hidden="true">7.4.</strong> HashChain</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="misc/hashchain/architecture.html"><strong aria-hidden="true">7.4.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="misc/hashchain/network_protocol.html"><strong aria-hidden="true">7.4.2.</strong> Network Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="misc/darkwiki.html"><strong aria-hidden="true">7.5.</strong> darkwiki</a></li><li class="chapter-item expanded "><a href="misc/dnetview.html"><strong aria-hidden="true">7.6.</strong> dnetview</a></li></ol></li><li class="chapter-item expanded "><a href="learn/learn.html"><strong aria-hidden="true">8.</strong> Learn</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="learn/research.html"><strong aria-hidden="true">8.1.</strong> Research</a></li><li class="chapter-item expanded "><a href="learn/zk_explainer.html"><strong aria-hidden="true">8.2.</strong> ZK explainer</a></li><li class="chapter-item expanded "><a href="learn/dchat/dchat.html"><strong aria-hidden="true">8.3.</strong> Dchat</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="learn/dchat/deployment/part-1.html"><strong aria-hidden="true">8.3.1.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="learn/dchat/deployment/getting-started.html"><strong aria-hidden="true">8.3.1.1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/writing-a-daemon.html"><strong aria-hidden="true">8.3.1.2.</strong> Writing a daemon</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/sessions.html"><strong aria-hidden="true">8.3.1.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/settings.html"><strong aria-hidden="true">8.3.1.4.</strong> Settings</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/error-handling.html"><strong aria-hidden="true">8.3.1.5.</strong> Error handling</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/start-run-stop.html"><strong aria-hidden="true">8.3.1.6.</strong> Start-Run-Stop</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/seed-node.html"><strong aria-hidden="true">8.3.1.7.</strong> Seed</a></li><li class="chapter-item expanded "><a href="learn/dchat/deployment/deploy.html"><strong aria-hidden="true">8.3.1.8.</strong> Deploy</a></li></ol></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/part-2.html"><strong aria-hidden="true">8.3.2.</strong> Creating dchat</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/message.html"><strong aria-hidden="true">8.3.2.1.</strong> Message</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/protocols.html"><strong aria-hidden="true">8.3.2.2.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/protocol-dchat.html"><strong aria-hidden="true">8.3.2.3.</strong> ProtocolDchat</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/register-protocol.html"><strong aria-hidden="true">8.3.2.4.</strong> Register protocol</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/sending-messages.html"><strong aria-hidden="true">8.3.2.5.</strong> Sending messages</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/ui.html"><strong aria-hidden="true">8.3.2.6.</strong> Slap on a UI</a></li><li class="chapter-item expanded "><a href="learn/dchat/creating-dchat/using-dchat.html"><strong aria-hidden="true">8.3.2.7.</strong> Using dchat</a></li></ol></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/part-3.html"><strong aria-hidden="true">8.3.3.</strong> Net tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="learn/dchat/network-tools/jsonrpcinterface.html"><strong aria-hidden="true">8.3.3.1.</strong> RPC interface</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/accept-addr.html"><strong aria-hidden="true">8.3.3.2.</strong> Accept addr</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/pong.html"><strong aria-hidden="true">8.3.3.3.</strong> Adding methods</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/server.html"><strong aria-hidden="true">8.3.3.4.</strong> RPC server</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/get-info.html"><strong aria-hidden="true">8.3.3.5.</strong> get_info</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/using-dnetview.html"><strong aria-hidden="true">8.3.3.6.</strong> Using dnetview</a></li><li class="chapter-item expanded "><a href="learn/dchat/network-tools/debug.html"><strong aria-hidden="true">8.3.3.7.</strong> Debugging</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <!-- Make the book title only appear if it is *not* the chapter title as well -->
                    <h1 id="book-title" class="menu-title">The DarkFi Book</h1>
                    <script type="text/javascript">
                        var bookTitleElement = document.getElementById('book-title')
                        var bookTitle = 'The DarkFi Book';
                        var chapterTitle = '';
                        if (bookTitle === chapterTitle) {
                            bookTitleElement.innerText = null;
                            document.title = bookTitle;
                        }
                    </script>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfi"><a class="header" href="#darkfi">DarkFi</a></h1>
<p><img src="https://img.shields.io/github/workflow/status/darkrenaissance/darkfi/CI%20Checks?style=flat-square" alt="Build Status" />
<a href="https://dark.fi"><img src="https://img.shields.io/badge/Web-dark.fi-white?logo=firefox&amp;logoColor=white&amp;style=flat-square" alt="Web - dark.fi" /></a>
<a href="https://dark.fi/manifesto.html"><img src="https://img.shields.io/badge/Manifesto-unsystem-informational?logo=minutemailer&amp;logoColor=white&amp;style=flat-square" alt="Manifesto - unsystem" /></a>
<a href="https://darkrenaissance.github.io/darkfi"><img src="https://img.shields.io/badge/Book-mdbook-orange?logo=gitbook&amp;logoColor=white&amp;style=flat-square" alt="Book - mdbook" /></a></p>
<h2 id="connect-to-darkfi-irc"><a class="header" href="#connect-to-darkfi-irc">Connect to DarkFi IRC</a></h2>
<p>Follow the <a href="https://darkrenaissance.github.io/darkfi/misc/ircd.html#installation">installation instructions</a>
for the P2P IRC daemon.</p>
<h2 id="build"><a class="header" href="#build">Build</a></h2>
<p>This project requires the Rust compiler to be installed. 
Please visit <a href="https://rustup.rs/">Rustup</a> for instructions.</p>
<p>The following dependencies are also required:</p>
<div class="table-wrapper"><table><thead><tr><th>Dependency</th><th>Debian-based</th></tr></thead><tbody>
<tr><td>gcc, gcc-c++, kernel headers</td><td>build-essential</td></tr>
<tr><td>cmake</td><td>cmake</td></tr>
<tr><td>jq</td><td>jq</td></tr>
<tr><td>wget</td><td>wget</td></tr>
<tr><td>pkg-config</td><td>pkg-config</td></tr>
<tr><td>clang</td><td>clang</td></tr>
<tr><td>clang libs</td><td>libclang-dev</td></tr>
<tr><td>llvm libs</td><td>llvm-dev</td></tr>
<tr><td>udev libs</td><td>libudev-dev</td></tr>
<tr><td>freetype2 libs</td><td>libfreetype6-dev</td></tr>
<tr><td>expat xml lib</td><td>libexpat1-dev</td></tr>
</tbody></table>
</div>
<p>Users of Debian-based systems (e.g. Ubuntu) can simply run the
following to install the required dependencies:</p>
<pre><code class="language-shell"># apt-get update
# apt-get install -y build-essential cmake jq wget pkg-config \
    clang libclang-dev llvm-dev libudev-dev libfreetype6-dev \
    libexpat1-dev
</code></pre>
<p>Alternatively, users can try using the automated script under <code>contrib</code>
folder by executing:</p>
<pre><code class="language-shell">% sh contrib/dependency_setup.sh
</code></pre>
<p>The script will try to recognize which system you are running,
and install dependencies accordingly. In case it does not find your
package manager, please consider adding support for it into the script
and sending a patch.</p>
<p>To build the necessary binaries, we can just clone the repo, and use
the provided Makefile to build the project. This will download the
trusted setup params, and compile the source code.</p>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi
% cd darkfi/
% make
</code></pre>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>If you want to hack on the source code, make sure to read some
introductory advice in the
<a href="https://darkrenaissance.github.io/darkfi/development.html">DarkFi book</a>.</p>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<p>This will install the binaries on your system (<code>/usr/local</code> by
default). The configuration files for the binaries are bundled with the
binaries and contain sane defaults. You'll have to run each daemon once
in order for them to spawn a config file, which you can then review.</p>
<pre><code class="language-shell"># make install
</code></pre>
<h2 id="bash-completion"><a class="header" href="#bash-completion">Bash Completion</a></h2>
<p>This will add the options auto completion of <code>drk</code> and <code>darkfid</code>.</p>
<pre><code class="language-shell">% echo source (pwd)/contrib/auto-complete &gt;&gt; ~/.bashrc
</code></pre>
<h3 id="examples-and-usage"><a class="header" href="#examples-and-usage">Examples and usage</a></h3>
<p>See the <a href="https://darkrenaissance.github.io/darkfi">DarkFi book</a></p>
<h2 id="go-dark"><a class="header" href="#go-dark">Go Dark</a></h2>
<p>Let's liberate people from the claws of big tech and create the
democratic paradigm of technology.</p>
<p>Self-defense is integral to any organism's survival and growth.</p>
<p>Power to the minuteman.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="definition-of-democratic-civilization"><a class="header" href="#definition-of-democratic-civilization">Definition of Democratic Civilization</a></h1>
<p>From 'The Sociology of Freedom: Manifesto of the Democratic
Civilization, Volume 3' by Abdullah Ocalan.</p>
<p>Annotations are our own. The text is otherwise unchanged.</p>
<h2 id="what-is-the-subject-of-moral-and-political-society"><a class="header" href="#what-is-the-subject-of-moral-and-political-society">What is the subject of moral and political society?</a></h2>
<p>The school of social science that postulates the examination of the
existence and development of social nature on the basis of moral and
political society could be defined as the democratic civilization
system. The various schools of social science base their analyses
on different units.  Theology and religion prioritize society. For
scientific socialism, it is class.  The fundamental unit for liberalism
is the individual. There are, of course, schools that prioritize
power and the state and others that focus on civilization.  All these
unit-based approaches must be criticized, because, as I have frequently
pointed out, they are not historical, and they fail to address the
totality. A meaningful examination would have to focus on what is
crucial from the point of view of society, both in terms of history
and actuality. Otherwise, the result will only be one more discourse.</p>
<p>Identifying our fundamental unit as moral and political society is
significant, because it also covers the dimensions of historicity
and totality.  Moral and political society is the most historical and
holistic expression of society. Morals and politics themselves can
be understood as history.  A society that has a moral and political
dimension is a society that is the closest to the totality of all its
existence and development. A society can exist without the state,
class, exploitation, the city, power, or the nation, but a society
devoid of morals and politics is unthinkable. Societies may exist as
colonies of other powers, particularly capital and state monopolies,
and as sources of raw materials. In those cases, however, we are
talking about the legacy of a society that has ceased to be.</p>
<h2 id="individualism-is-a-state-of-war"><a class="header" href="#individualism-is-a-state-of-war">Individualism is a state of war</a></h2>
<p>There is nothing gained by labeling moral and political society—the
natural state of society—as slave-owning, feudal, capitalist,
or socialist.  Using such labels to describe society masks
reality and reduces society to its components (class, economy, and
monopoly). The bottleneck encountered in discourses based on such
concepts as regards the theory and practice of social development
stems from errors and inadequacies inherent in them. If all of the
analyses of society referred to with these labels that are closer to
historical materialism have fallen into this situation, it is clear
that discourses with much weaker scientific bases will be in a much
worse situation. Religious discourses, meanwhile, focus heavily on
the importance of morals but have long since turned politics over to
the state.  Bourgeois liberal approaches not only obscure the society
with moral and political dimensions, but when the opportunity presents
itself they do not hesitate to wage war on this society. Individualism
is a state of war against society to the same degree as power and the
state is. Liberalism essentially prepares society, which is weakened
by being deprived of its morals and politics, for all kinds of attacks
by individualism. Liberalism is the ideology and practice that is
most anti-society.</p>
<h2 id="the-rise-of-scientific-positivism"><a class="header" href="#the-rise-of-scientific-positivism">The rise of scientific positivism</a></h2>
<p>In Western sociology (there is still no science called Eastern
sociology) concepts such as society and civilization system are
quite problematic.  We should not forget that the need for sociology
stemmed from the need to find solutions to the huge problems of
crises, contradictions, and conflicts and war caused by capital and
power monopolies. Every branch of sociology developed its own thesis
about how to maintain order and make life more livable. Despite
all the sectarian, theological, and reformist interpretations
of the teachings of Christianity, as social problems deepened,
interpretations based on a scientific (positivist) point of view
came to the fore. The philosophical revolution and the Enlightenment
(seventeenth and eighteenth centuries) were essentially the result
of this need.  When the French Revolution complicated society’s
problems rather than solving them, there was a marked increase in
the tendency to develop sociology as an independent science. Utopian
socialists (Henri de Saint-Simon, Charles Fourier, and Pierre-Joseph
Proudhon), together with Auguste Comte and Émile Durkheim, represent
the preliminary steps in this direction.  All of them are children
of the Enlightenment, with unlimited faith in science. They believed
they could use science to re-create society as they wished. They
were playing God. In Hegel’s words, God had descended to earth
and, what’s more, in the form of the nation-state. What needed to
be done was to plan and develop specific and sophisticated “social
engineering” projects. There was no project or plan that could not be
achieved by the nation-state if it so desired, as long as it embraced
the “scientific positivism” and was accepted by the nation-state!</p>
<h2 id="capitalism-as-an-iron-cage"><a class="header" href="#capitalism-as-an-iron-cage">Capitalism as an iron cage</a></h2>
<p>British social scientists (political economists) added economic
solutions to French sociology, while German ideologists contributed
philosophically.  Adam Smith and Hegel in particular made major
contributions.  There was a wide variety of prescriptions from
both the left and right to address the problems arising from the
horrendous abuse of the society by the nineteenth-century industrial
capitalism. Liberalism, the central ideology of the capitalist
monopoly has a totally eclectic approach, taking advantage of any
and all ideas, and is the most practical when it comes to creating
almost patchwork-like systems. It was as if the right- and left-
wing schematic sociologies were unaware of social nature, history,
and the present while developing their projects in relation to the
past (the quest for the “golden age” by the right) or the future
(utopian society). Their systems would continually fragment when they
encountered history or current life. The reality that had imprisoned
them all was the “iron cage” that capitalist modernity had slowly
cast and sealed them in, intellectually and in their practical way
of life. However, Friedrich Nietzsche’s ideas of metaphysicians
of positivism or castrated dwarfs of capitalist modernity bring us
a lot closer to the social truth. Nietzsche leads the pack of rare
philosophers who first drew attention to the risk of society being
swallowed up by capitalist modernity. Although he is accused of
serving fascism with his thoughts, his foretelling of the onset of
fascism and world wars was quite enticing.</p>
<p>The increase in major crises and world wars, along with the division of
the liberal center into right- and left-wing branches, was enough to
bankrupt positivist sociology. In spite of its widespread criticism
of metaphysics, social engineering has revealed its true identity
with authoritarian and totalitarian fascism as metaphysics at
its shallowest.  The Frankfurt School is the official testimonial
of this bankruptcy. The École Annales and the 1968 youth uprising
led to various postmodernist sociological approaches, in particular
Immanuel Wallerstein’s capitalist world-system analysis. Tendencies
like ecology, feminism, relativism, the New Left, and world-system
analysis launched a period during which the social sciences
splintered. Obviously, financial capital gaining hegemony as
the 1970s faded also played an important role. The upside of these
developments was the collapse of the hegemony of Eurocentric thought.
The downside, however, was the drawbacks of a highly fragmented
social sciences.</p>
<h2 id="the-problems-of-eurocentric-sociology"><a class="header" href="#the-problems-of-eurocentric-sociology">The problems of Eurocentric sociology</a></h2>
<p>Let’s summarize the criticism of Eurocentric sociology:</p>
<ol>
<li>
<p>Positivism, which criticized and denounced both religion and
metaphysics, has not escaped being a kind of religion and metaphysics
in its own right. This should not come as a surprise.  Human culture
requires metaphysics. The issue is to distinguish good from bad
metaphysics.</p>
</li>
<li>
<p>An understanding of society based on dichotomies like primitive vs.
modern, capitalist vs. socialist, industrial vs. agrarian, progressive
vs. reactionary, divided by class vs. classless, or with a state
vs. stateless prevents the development of a definition that comes
closer to the truth of social nature. Dichotomies of this sort distance
us from social truth.</p>
</li>
<li>
<p>To re-create society is to play the modern god. More precisely, each
time society is recreated there is a tendency to form a new capital
and power-state monopoly. Much like medieval theism was ideologically
connected to absolute monarchies (sultanates and shāhanshāhs),
modern social engineering as rereation is essentially the divine
disposition and ideology of the nation-state. Positivism in this
regard is modern theism.</p>
</li>
<li>
<p>Revolutions cannot be interpreted as the re-creation acts of
society. When thusly understood they cannot escape positivist
theism. Revolutions can only be defined as social revolutions to
the extent that they free society from excessive burden of capital
and power.</p>
</li>
<li>
<p>The task of revolutionaries cannot be defined as creating any
social model of their making but more correctly as playing a role in
contributing to the development of moral and political society.</p>
</li>
<li>
<p>Methods and paradigms to be applied to social nature should not be
identical to those that relate to first nature. While the universalist
approach to first nature provides results that come closer to the
truth (I don’t believe there is an absolute truth), relativism in
relation to social nature may get us closer to the truth. The universe
can neither be explained by an infinite universalist linear discourse
or by a concept of infinite similar circular cycles.</p>
</li>
<li>
<p>A social regime of truth needs to be reorganized on the basis of
these and many other criticisms. Obviously, I am not talking about
a new divine creation, but I do believe that the greatest feature of
the human mind is the power to search for and build truth.</p>
</li>
</ol>
<h2 id="a-new-social-science"><a class="header" href="#a-new-social-science">A new social science</a></h2>
<p>In light of these criticisms, I offer the following suggestions in
relation to the social science system that I want to define:</p>
<h3 id="a-more-humane-social-nature"><a class="header" href="#a-more-humane-social-nature">A more humane social nature</a></h3>
<ol>
<li>
<p>I would not present social nature as a rigid universalist truth with
mythological, religious, metaphysical, and scientific (positivist)
patterns. Understanding it to be the most flexible form of basic
universal entities that encompass a wealth of diversities but are
tied down to conditions of historical time and location more closely
approaches the truth. Any analysis, social science, or attempt to make
practical change without adequate knowledge of the qualities of social
nature may well backfire. The monotheistic religions and positivism,
which have appeared throughout the history of civilization claiming
to have found the solution, were unable to prevent capital and power
monopolies from gaining control. It is therefore their irrevocable
task, if they are to contribute to moral and political society,
to develop a more humane analysis based on a profound self-criticism.</p>
</li>
<li>
<p>Moral and political society is the main element that gives social
nature its historical and complete meaning and represents the unity in
diversity that is basic to its existence. It is the definition of moral
and political society that gives social nature its character, maintains
its unity in diversity, and plays a decisive role in expressing its
main totality and historicity. The descriptors commonly used to define
society, such as primitive, modern, slave-owning, feudal, capitalist,
socialist, industrial, agricultural, commercial, monetary, statist,
national, hegemonic, and so on, do not reflect the decisive features
of social nature. On the contrary, they conceal and fragment its
meaning. This, in turn, provides a base for faulty theoretical and
practical approaches and actions related to society.</p>
</li>
</ol>
<h3 id="protecting-the-social-fabric"><a class="header" href="#protecting-the-social-fabric">Protecting the social fabric</a></h3>
<ol start="3">
<li>
<p>Statements about renewing and re-creating society are part of
operations meant to constitute new capital and power monopolies in
terms of their ideological content. The history of civilization, the
history of such renewals, is the history of the cumulative accumulation
of capital and power. Instead of divine creativity, the basic action
the society needs most is to struggle against factors that prevent the
development and functioning of moral and political social fabric. A
society that operates its moral and political dimensions freely,
is a society that will continue its development in the best way.</p>
</li>
<li>
<p>Revolutions are forms of social action resorted to when society
is sternly prevented from freely exercising and maintaining its
moral and political function. Revolutions can and should be accepted
as legitimate by society only when they do not seek to create new
societies, nations, or states but to restore moral and political
society its ability to function freely.</p>
</li>
<li>
<p>Revolutionary heroism must find meaning through its contributions
to moral and political society. Any action that does not have this
meaning, regardless of its intent and duration, cannot be defined as
revolutionary social heroism. What determines the role of individuals
in society in a positive sense is their contribution to the development
of moral and political society.</p>
</li>
<li>
<p>No social science that hopes to develop these key features through
profound research and examination should be based on a universalist
linear progressive approach or on a singular infinite cyclical
relativity. In the final instance, instead of these dogmatic approaches
that serve to legitimize the cumulative accumulation of capital and
power throughout the history of civilization, social sciences based
on a non-destructive dialectic methodology that harmonizes analytical
and emotional intelligence and overcomes the strict subject-object
mold should be developed.</p>
</li>
</ol>
<h2 id="the-framework-of-moral-and-political-society"><a class="header" href="#the-framework-of-moral-and-political-society">The framework of moral and political society</a></h2>
<p>The paradigmatic and empirical framework of moral and political
society, the main unit of the democratic civilization system, can be
presented through such hypotheses. Let me present its main aspects:</p>
<ol>
<li>
<p>Moral and political society is the fundamental aspect of human
society that must be continuously sought. Society is essentially
moral and political.</p>
</li>
<li>
<p>Moral and political society is located at the opposite end of the
spectrum from the civilization systems that emerged from the triad
of city, class, and state (which had previously been hierarchical
structures).</p>
</li>
<li>
<p>Moral and political society, as the history of social nature,
develops in harmony with the democratic civilization system.</p>
</li>
<li>
<p>Moral and political society is the freest society. A functioning
moral and political fabric and organs is the most decisive dynamic
not only for freeing society but to keep it free. No revolution or
its heroines and heroes can free the society to the degree that the
development of a healthy moral and political dimension will.  Moreover,
revolution and its heroines and heroes can only play a decisive role
to the degree that they contribute to moral and political society.</p>
</li>
<li>
<p>A moral and political society is a democratic society. Democracy
is only meaningful on the basis of the existence of a moral and
political society that is open and free. A democratic society where
individuals and groups become subjects is the form of governance
that best develops moral and political society. More precisely,
we call a functioning political society a democracy. Politics and
democracy are truly identical concepts. If freedom is the space within
which politics expresses itself, then democracy is the way in which
politics is exercised in this space. The triad of freedom, politics,
and democracy cannot lack a moral basis. We could refer to morality
as the institutionalized and traditional state of freedom, politics,
and democracy.</p>
</li>
<li>
<p>Moral and political societies are in a dialectical contradiction
with the state, which is the official expression of all forms of
capital, property, and power. The state constantly tries to substitute
law for morality and bureaucracy for politics. The official state
civilization develops on one side of this historically ongoing
contradiction, with the unofficial democratic civilization system
developing on the other side. Two distinct typologies of meaning
emerge.  Contradictions may either grow more violent and lead to war
or there may be reconciliation, leading to peace.</p>
</li>
<li>
<p>Peace is only possible if moral and political society forces
and the state monopoly forces have the will to live side by side
unarmed and with no killing. There have been instances when rather
than society destroying the state or the state destroying society,
a conditional peace called democratic reconciliation has been
reached. History doesn’t take place either in the form of democratic
civilization—as the expression of moral and political society—or
totally in the form of civilization systems—as the expression of
class and state society. History has unfolded as intense relationship
rife with contradiction between the two, with successive periods of
war and peace. It is quite utopian to think that this situation, with
at least a five-thousand-year history, can be immediately resolved
by emergency revolutions. At the same time, to embrace it as if it
is fate and cannot be interfered with would also not be the correct
moral and political approach.  Knowing that struggles between systems
will be protracted, it makes more sense and will prove more effective
to adopt strategic and tactical approaches that expand the freedom
and democracy sphere of moral and political society.</p>
</li>
<li>
<p>Defining moral and political society in terms of communal,
slave-owning, feudal, capitalist, and socialist attributes serves
to obscure rather than elucidate matters. Clearly, in a moral and
political society there is no room for slave-owning, feudal, or
capitalist forces, but, in the context of a principled reconciliation,
it is possible to take an aloof approach to these forces, within
limits and in a controlled manner. What’s important is that moral
and political society should neither destroy them nor be swallowed up
by them; the superiority of moral and political society should make
it possible to continuously limit the reach and power of the central
civilization system. Communal and socialist systems can identify
with moral and political society insofar as they themselves are
democratic. This identification is, however, not possible, if they
have a state.</p>
</li>
<li>
<p>Moral and political society cannot seek to become a nation-state,
establish an official religion, or construct a non-democratic
regime. The right to determine the objectives and nature of society
lies with the free will of all members of a moral and political
society. Just as with current debates and decisions, strategic
decisions are the purview of society’s moral and political will and
expression. The essential thing is to have discussions and to become
a decision-making power. A society who holds this power can determine
its preferences in the soundest possible way. No individual or force
has the authority to decide on behalf of moral and political society,
and social engineering has no place in these societies.</p>
</li>
</ol>
<h2 id="liberating-democratic-civilization-from-the-state"><a class="header" href="#liberating-democratic-civilization-from-the-state">Liberating democratic civilization from the State</a></h2>
<p>When viewed in the light of the various broad definitions I
have presented, it is obvious that the democratic civilization
system—essentially the moral and political totality of social
nature—has always existed and sustained itself as the flip side of
the official history of civilization. Despite all the oppression and
exploitation at the hands of the official world-system, the other face
of society could not be destroyed. In fact, it is impossible to destroy
it. Just as capitalism cannot sustain itself without noncapitalist
society, civilization— the official world system— also cannot
sustain itself without the democratic civilization system. More
concretely the civilization with monopolies cannot sustain itself
without the existence of a civilization without monopolies. The
opposite is not true. Democratic civilization, representing the
historical flow of the system of moral and political society, can
sustain itself more comfortably and with fewer obstacles in the
absence of the official civilization.</p>
<p>I define democratic civilization as a system of thought, the
accumulation of thought, and the totality of moral rules and political
organs. I am not only talking about a history of thought or the social
reality within a given moral and political development. The discussion
does, however, encompass both issues in an intertwined manner. I
consider it important and necessary to explain the method in terms of
democratic civilization’s history and elements, because this totality
of alternate discourse and structures are prevented by the official
civilization. I will address these issues in subsequent sections.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="notes-for-developers"><a class="header" href="#notes-for-developers">Notes for developers</a></h1>
<h2 id="making-life-easy-for-others"><a class="header" href="#making-life-easy-for-others">Making life easy for others</a></h2>
<blockquote>
<p><strong>Write useful commit messages.</strong></p>
</blockquote>
<p>If your commit is changing a specific module in the code and not
touching other parts of the codebase (as should be the case 99% of the
time), consider writing a useful commit message that also mentions
which module was changed.</p>
<p>For example, a message like:</p>
<blockquote>
<p><code>added foo</code></p>
</blockquote>
<p>is not as clear as</p>
<blockquote>
<p><code>crypto/keypair: Added foo method for Bar struct.</code></p>
</blockquote>
<p>Also keep in mind that commit messages can be longer than a single
line, so use it to your advantage to explain your commit and
intentions.</p>
<h2 id="cargo-fmt-pre-commit-hook"><a class="header" href="#cargo-fmt-pre-commit-hook">cargo fmt pre-commit hook</a></h2>
<p>To ensure every contributor uses the same code style, make sure
you run <code>cargo +nightly fmt</code> before committing. You can force yourself
to do this by creating a git <code>pre-commit</code> hook like the following:</p>
<pre><code class="language-shell">#!/bin/sh
if ! cargo +nightly fmt -- --check &gt;/dev/null; then
    echo &quot;There are some code style issues. Run 'cargo +nightly fmt' to fix it.&quot;
    exit 1
fi

exit 0
</code></pre>
<p>Place this script in <code>.git/hooks/pre-commit</code> and make sure it's
executable by running <code>chmod +x .git/hooks/pre-commit</code>.</p>
<h2 id="testing-crate-features"><a class="header" href="#testing-crate-features">Testing crate features</a></h2>
<p>Our library heavily depends on cargo <em>features</em>. Currently
there are more than 650 possible combinations of features to
build the library.  To ensure everything can always compile
and works, we can use a helper for <code>cargo</code> called
<a href="https://github.com/taiki-e/cargo-hack"><code>cargo hack</code></a>.</p>
<p>The <code>Makefile</code> provided in the repository is already set up to use it,
so it's enough to install <code>cargo hack</code> and run <code>make check</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="p2p-port-ranges"><a class="header" href="#p2p-port-ranges">P2P port ranges</a></h1>
<p>Standard port ranges used by DarkFi.</p>
<ul>
<li>lilith: 25551</li>
<li>darkfid-sync: 33032</li>
<li>darkfid-consensus: 33033</li>
<li>ircd: 25551</li>
<li>taud: 23331</li>
<li>darkwikid: 24331</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="architecture-design"><a class="header" href="#architecture-design">Architecture design</a></h1>
<p>This section of the book shows the software architecture of DarkFi and
the network implementations.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>DarkFi is a layer one proof-of-stake blockchain that supports anonymous
applications. It is currently under development. This overview will
outline a few key terms that help explain DarkFi.</p>
<p><strong>Cashier:</strong> The Cashier is the entry and exit point to the DarkFi
network from other blockchains such as Ethereum, Bitcoin and Solana. It is
essentially the bridge. Its role is to exchange cryptocurrency assets for
anonymous <em>darkened</em> tokens that are pegged to the underlying currency,
and visa versa. Currently, the role of the Cashier is trusted and
centralized. As a next step, DarkFi plans to implement trust-minimized
bridges and eventually fully trustless bridges.</p>
<p><strong>Blockchain:</strong> Once new anonymous tokens (e.g. dETH) have been issued,
the Cashier posts that data on the blockchain. This data is encrypted
and the transaction link is broken.</p>
<p>The DarkFi blockchain is currently using a very simple consensus protocol
called Streamlet. The blockchain is currently in devnet phase. This is a
local testnet ran by the DarkFi community. Currently, the blockchain has
no consensus token. DarkFi is working to upgrade to a privacy-enhanced
proof-of-stake algorithm called Ouroborus Crypsinous.</p>
<p><strong>Wallet:</strong> A wallet is a portal to the DarkFi network. It provides
the user with the ability to send and receive anonymous <em>darkened</em>
tokens. Each wallet is a full node and stores a copy of the
blockchain. All contract execution is done locally on the DarkFi wallet.</p>
<p><strong>P2P Network:</strong> The DarkFi ecosystem runs as a network of P2P nodes,
where these nodes interact with each other over specific protocols (see
<a href="architecture/dna.html">node overview</a>). Nodes communicate on a peer-to-peer network,
which is also home to tools such as our P2P <a href="architecture/../misc/ircd.html">irc</a>
and P2P task manager <a href="architecture/../misc/tau.html">tau</a>.</p>
<p><strong>ZK smart contracts:</strong> Anonymous applications on DarkFi run on proofs
that enforce an order of operations. We call these zero-knowledge smart
contracts. Anonymous transactions on DarkFi is possible due to the
interplay of two contracts, mint and burn (see the <a href="architecture/../zkas/examples/sapling.html">sapling payment
scheme</a>). Using the same method, we can
define advanced applications.</p>
<p><strong>zkas:</strong> zkas is the compiler used to compile zk smart contracts in
its respective assembly-like language. The &quot;assembly&quot; part was chosen as
it's the bare primitives needed for zk proofs, so later on the language
can be expanded with higher-level syntax. Zkas enables developers to
compile and inspect contracts.</p>
<p><strong>zkVM:</strong> DarkFi's zkVM executes the binaries produced by zkas. The
zkVM aims to be a general-purpose zkSNARK virtual machine that empowers
developers to quickly prototype and debug zk contracts. It uses a
trustless zero-knowledge proof system called Halo 2 with no trusted setup.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="layers"><a class="header" href="#layers">Layers</a></h1>
<ul>
<li><strong>system/</strong> contains core functionality, types and utilities.</li>
<li><strong>net/</strong> is the p2p networking base layer.</li>
<li><strong>service/</strong> any services such as the cashier or gateways.</li>
<li><strong>zk/</strong> is the zk virtual machine and related zk code.</li>
<li><strong>zkas/</strong> is the zk assembly language and compiler.</li>
<li><strong>crypto/</strong> for the merkle tree classes and other crypto primitives.</li>
<li><strong>node/</strong> is a fully working darkfi node.</li>
<li><strong>wallet/</strong> key generation and management features such as derivation and storage.</li>
<li><strong>tx/</strong> for the transaction builder.</li>
<li><strong>blockchain/</strong> blockchain database functionality and state transition.</li>
<li><strong>consensus/</strong> implementation of the streamlet consensus algorithm.</li>
<li><strong>rpc/</strong> interface for remote procedure calls, includes adapter to interface with the node backend and the default jsonrpc transport mechanism.</li>
<li><strong>util/</strong> various utilities.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anonymous-assets"><a class="header" href="#anonymous-assets">Anonymous assets</a></h1>
<p>DarkFi network allows for the issuance and transfer of anonymous assets
with an arbitrary number of parameters. These tokens are anonymous,
relying on zero-knowledge proofs to ensure validity without revealing
any other information.</p>
<p>New tokens are created and destroyed every time you send an anonymous
transaction. To send a transaction on DarkFi, you must first issue a
credential that commits to some value you have in your wallet. This is
called the <strong>Mint</strong> phase. Once the credential is spent, it destroys
itself: what is called the <strong>Burn.</strong></p>
<p>Through this process, the link between inputs and outputs is broken.</p>
<p><img src="architecture/transaction.png" alt="" /></p>
<h2 id="mint"><a class="header" href="#mint">Mint</a></h2>
<p>During the <strong>Mint</strong> phase we create a new coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, which is bound
to the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>. The coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> is publicly revealed on the
blockchain and added to the merkle tree, which is stored locally on
the DarkFi wallet.</p>
<p>We do this using the following process:</p>
<p>Let <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> be the coin's value. Generate random <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and serial
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span>.</p>
<p>Create a commitment to these parameters in zero-knowledge:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>Check that the value commitment is constructed correctly:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>Reveal <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>. Add <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> to the Merkle tree.</p>
<h2 id="burn"><a class="header" href="#burn">Burn</a></h2>
<p>When we spend the coin, we must ensure that the value of the coin
cannot be double spent. We call this the <em>Burn</em> phase. The process
relies on a <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> nullifier, which we create  using the secret key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>
for the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>. Nullifiers are unique per coin and prevent
double spending. <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> is the Merkle root. <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> is the coin's value.</p>
<p>Generate a random number <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mclose">)</span></span></span></span></span></p>
<p>Check that the secret key corresponds to a public key:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">G</span></span></span></span></span></p>
<p>Check that the public key corresponds to a coin which is in the merkle
tree <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<p>Check that the value commitment is constructed correctly:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>Reveal <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>. Check <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> is a valid Merkle root. Check <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>
does not exist in the nullifier set.</p>
<p>The zero-knowledge proof confirms that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> binds to an unrevealed value
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, and that this coin is in the Merkle tree, without linking <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>
to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>. Once the nullifier is produced the coin becomes unspendable.</p>
<h2 id="adding-values"><a class="header" href="#adding-values">Adding values</a></h2>
<p>Assets on DarkFi can have any number of values or attributes. This
is achieved by creating a credential <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> and hashing any number of
values and checking that they are valid in zero-knowledge.</p>
<p>We check that the sum of the inputs equals the sum of the outputs. This
means that:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.6em;vertical-align:-0.55em;"></span><span class="mop op-symbol large-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.6em;vertical-align:-0.55em;"></span><span class="mop op-symbol large-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>And that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> is a valid point on the curve <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>This proves that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord">0</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> is a secret
blinding factor for the amounts.</p>
<h1 id="diagram"><a class="header" href="#diagram">Diagram</a></h1>
<p><img src="architecture/diagram-dkzk.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="dynamic-proof-of-stake"><a class="header" href="#dynamic-proof-of-stake">Dynamic Proof of Stake</a></h1>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>DarkFi's current blockchain is based on Streamlet, a very simple consensus
system based on voting between the participating parties. The blockchain
is currently in the devnet phase and has no concept of a consensus token.</p>
<p>Darkfi is actively working to upgrade its consensus to Ouroboros
Crypsinous, a privacy focused proof-of-stake algorithm. To accommodate
this transition it has designed its data structures to be easy to upgrade.</p>
<p>Below is a specification of how DarkFi's current blockchain achieves
consensus.</p>
<h2 id="blockchain"><a class="header" href="#blockchain">Blockchain</a></h2>
<p>Blockchain <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span> is a series of epochs: it's a tree of chains,
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.123em;"></span><span class="minner">…</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, the chain of the max length in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">C</span></span></span></span>
is the driving chain C.</p>
<h2 id="epoch"><a class="header" href="#epoch">Epoch</a></h2>
<p>An epoch is a multiple of blocks. Some of those blocks might be empty
due to the nature of the leader selection with VRF.</p>
<h2 id="genesis-block"><a class="header" href="#genesis-block">Genesis block</a></h2>
<p>The first block in the epoch updates the stake for stakeholders, which
influences the weighted random leader selection algorithm. For epoch j,
the pair (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>) is the genesis block's data for n stakeholders
of the blockchain:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2333em;vertical-align:-0.2663em;"></span><span class="mopen">((</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.4337em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2663em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">es</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.967em;"><span style="top:-2.4337em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2663em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">es</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">λ</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><sup><strong>Note that new stakeholders need to wait for the next epoch
to be added to the genesis block</strong></sup></p>
<h2 id="block"><a class="header" href="#block">Block</a></h2>
<p>A block <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord text"><span class="mord textbf">B</span></span></span></span></span> is the building block of the blockchain.</p>
<p>Block <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> created for slot i
by a stakeholder, and slot i leader <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6349em;"></span><span class="mord text"><span class="mord textbf" style="color:red;">st</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">state of the previous block, Hash(head(</span><span class="mord mathbb">C</span><span class="mord">))</span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord textbf" style="color:red;">d</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">data held by the block</span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord textbf" style="color:red;">sl</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">slot id generated by the beacon</span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord text"><span class="mord" style="color:red;"><span class="mord mathnormal" style="margin-right:0.05017em;color:red;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight" style="color:red;"><span class="mord mathnormal mtight" style="margin-right:0.03588em;color:red;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">proof the stakeholder </span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mord"> is the owner, </span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mclose">)</span><span class="mord">, y,</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord"> are the output of the VRF</span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord mathnormal" style="color:red;">ρ</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">random seed for vrf, </span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord text"><span class="mord" style="color:red;"><span class="mord mathnormal" style="margin-right:0.03588em;color:red;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight" style="color:red;"><span class="mord mtight" style="color:red;"><span class="mord mathnormal mtight" style="color:red;">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">owner signature on the block</span></span></span></span></span></span></p>
<h2 id="leader-selection"><a class="header" href="#leader-selection">Leader selection</a></h2>
<p>At the onset of each slot each stakeholder needs to verify if it's
the weighted random leader for this slot.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <center><sup><strong>check if VRF output is less than some
threshold </strong></sup></center></p>
<p>This statement might hold true for zero or more stakeholders, thus
we might end up with multiple leaders for a slot, and other times no
leader. Also note that no one would know who the leader is or how many
leaders are there for the slot, until you receive a signed block with
a proof claiming to be a leader.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.13889em;">RF</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="mord">∣∣</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></span></p>
<center><sup><strong><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span> is random nonce generated from the blockchain,
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord textbf">sid</span></span></span></span></span> is block id</strong></sup></center>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2287em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">RF</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9426em;"><span style="top:-2.4231em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>Note that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord textbf">f</span></span></span></span></span>: the active slot coefficient is
the probability that a party holding all the stake will be selected to be
a leader. Stakeholder is selected as leader for slot j with probability
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> stake.</p>
<p>The following are absolute stake aggregation dependent leader selection
family of functions.</p>
<h3 id="linear-family-functions"><a class="header" href="#linear-family-functions">Linear family functions</a></h3>
<p>In the previous leader selection function, it has the unique
property of independent aggregation of the stakes, meaning the
property of a leader winning leadership with stakes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span>
is independent of whether the stakeholder would act as a pool
of stakes, or distributed stakes on competing coins.  &quot;one minus
the probability&quot; of winning leadership with aggregated stakes is
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1496em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>,
the joint &quot;one minus probability&quot; of all the stakes (each with
probability <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span> winning aggregated winning the leadership
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1496em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> thus: <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p>
<p>A non-exponential  linear leader selection can be:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span> <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2158em;vertical-align:-0.8943em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2583em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mord mtight">+</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8943em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">Z</span></span></span></span></span></p>
<h4 id="dependent-aggregation"><a class="header" href="#dependent-aggregation">Dependent aggregation</a></h4>
<p>Linear leader selection has the dependent aggregation property, meaning
it's favorable to compete in pools with sum of the stakes over aggregated
stakes of distributed stakes:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> let's assume the stakes are divided to stakes of value
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> for <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord">Σ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">Z</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span> note that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2902em;vertical-align:-0.4451em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, thus competing with single coin of the sum of stakes held by
the stakeholder is favorable.</p>
<h4 id="scalar-linear-aggregation-dependent-leader-selection"><a class="header" href="#scalar-linear-aggregation-dependent-leader-selection">Scalar linear aggregation dependent leader selection</a></h4>
<p>A target function T with scalar coefficients can be formalized as
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord">Σ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1574em;vertical-align:-0.836em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mord">Σ</span></span></span></span></span> let's assume
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span></span></span>, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> then: <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord">Σ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span><span class="mord">Σ</span></span></span></span></span>
then the lead statement is <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span><span class="mord">Σ</span></span></span></span></span> for example for a group
order or l=    24 bits, and maximum value of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span></span></span></span></span></span></span></span>, then
lead statement: <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">14</span></span></span></span></span></span></span></span></span><span class="mord">Σ</span></span></span></span></span></p>
<h4 id="competing-max-value-coins"><a class="header" href="#competing-max-value-coins">Competing max value coins</a></h4>
<p>For a stakeholder with <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> absolute stake, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">Z</span></span></span></span>
it's advantageous for the stakeholder to distribute stakes on <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>
competing coins.</p>
<h3 id="inverse-functions"><a class="header" href="#inverse-functions">Inverse functions</a></h3>
<p>Inverse lead selection functions doesn't require maximum stake, most
suitable for absolute stake, it has the disadvantage that it's inflating
with increasing rate as time goes on, but it can be function of the
inverse of the slot to control the increasing frequency of winning
leadership.</p>
<h4 id="leader-selection-without-maximum-stake-upper-limit"><a class="header" href="#leader-selection-without-maximum-stake-upper-limit">Leader selection without maximum stake upper limit</a></h4>
<p>The inverse leader selection without maximum stake value can be
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1533em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> and inversely proportional
with probability of winning leadership, let it be called leadership
coefficient.</p>
<h4 id="decaying-linear-leader-selection"><a class="header" href="#decaying-linear-leader-selection">Decaying linear leader selection</a></h4>
<p>As the time goes one, and stakes increase, this means the combined stakes
of all stakeholders increases the probability of winning leadership
in next slots leading to more leaders at a single slot, to maintain,
or to be more general to control this frequency of leaders per slot, c
(the leadership coefficient) need to be function of the slot <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>, i.e
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> is epoch size (number of slots in epoch).</p>
<h4 id="pairing-leader-selection-independent-aggregation-function"><a class="header" href="#pairing-leader-selection-independent-aggregation-function">Pairing leader selection independent aggregation function</a></h4>
<p>The only family of functions <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span></span></span></span> that are isomorphic
to summation on multiplication <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>(having the independent aggregation
property) is the exponential function, and since it's impossible to
implement in plonk,  a re-formalization of the lead statement using
pairing that is isomorphic to summation on multiplication is an option.</p>
<p>Let's assume <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ϕ</span></span></span></span> is isomorphic function
between multiplication and addition, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1591em;vertical-align:-0.345em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>,
thus:
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2786em;vertical-align:-1.5286em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span style="top:-1.4714em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord text mtight"><span class="mord mathnormal sizing reset-size3 size6" style="margin-right:0.0037em;">α</span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.75em;"><span class="svg-align" style="top:-2.102em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.548em;min-width:1.6em;"><span class="brace-left" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMinYMin slice'><path d='M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z'/></svg></span><span class="brace-center" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMidYMin slice'><path d='M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z'/></svg></span><span class="brace-right" style="height:0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='0.548em' viewBox='0 0 400000 548' preserveAspectRatio='xMaxYMin slice'><path d='M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z'/></svg></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.898em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5286em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span></span></span></span></span></span></span></span>
then the only family of functions <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ϕ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span> satisfying this is the exponential function
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6889em;"></span><span class="mord mathbb">R</span></span></span></span></span></p>
<h4 id="no-solution-for-the-lead-statement-parameters-and-constants-sfα-defined-over-group-of-integers"><a class="header" href="#no-solution-for-the-lead-statement-parameters-and-constants-sfα-defined-over-group-of-integers">no solution for the lead statement parameters, and constants <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> defined over group of integers.</a></h4>
<p>assume there is a solution for the lead statement parameters and constants <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span> defined over group of integers.
for the statement <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>, <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">Sϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose">)</span></span></span></span></span>
such that S <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span>
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ϕ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the maximum stake value being <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span></span></span></span>, following from the previous proof that the family of function haveing independent aggregation property is the exponential function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.0037em;">α</span></span></span></span></span></span></span></span></span></span></span>, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, the smallest value satisfying f is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>, then <span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0369em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0369em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
note that since <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> thus <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, contradiction.</p>
<h2 id="leaky-non-resettable-beacon"><a class="header" href="#leaky-non-resettable-beacon">Leaky non-resettable beacon</a></h2>
<p>Built on top of globally synchronized clock, that leaks the nonce <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span>
of the next epoch a head of time (thus called leaky), non-resettable
in the sense that the random nonce is deterministic at slot s, while
assuring security against adversary controlling some stakeholders.</p>
<p>For an epoch j, the nonce <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> is calculated by hash function H, as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣∣</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord">∣∣</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span></span></p>
<p>v is the concatenation of the value <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span> in all blocks from the
beginning of epoch <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> to the slot with timestamp up to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2834em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">ϵ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">16</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>, note that k is a persistence security parameter,
R is the epoch length in terms of slots.</p>
<h1 id="protocol"><a class="header" href="#protocol">Protocol</a></h1>
<h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<p>This section gives further details about the structures that will
be used by the protocol. Since the Streamlet consensus protocol will
be used at early stages of development, we created hybrid structures
to enable seamless transition from Stremlet to Ouroboros Crypsinous,
without the need of forking the blockchain.</p>
<h2 id="blockchain-1"><a class="header" href="#blockchain-1">Blockchain</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blocks</code></td><td><code>Vec&lt;Block&gt;</code></td><td>Series of blocks consisting the Blockchain</td></tr>
</tbody></table>
</div>
<h2 id="header"><a class="header" href="#header">Header</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>version</code></td><td><code>u8</code></td><td>Version</td></tr>
<tr><td><code>state</code></td><td><code>blake3Hash</code></td><td>Previous block hash</td></tr>
<tr><td><code>epoch</code></td><td><code>u64</code></td><td>Epoch</td></tr>
<tr><td><code>slot</code></td><td><code>u64</code></td><td>Slot UID</td></tr>
<tr><td><code>timestamp</code></td><td><code>Timestamp</code></td><td>Block creation timestamp</td></tr>
<tr><td><code>root</code></td><td><code>MerkleRoot</code></td><td>Root of the transaction hashes merkle tree</td></tr>
</tbody></table>
</div>
<h2 id="block-1"><a class="header" href="#block-1">Block</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>magic</code></td><td><code>u8</code></td><td>Magic bytes</td></tr>
<tr><td><code>header</code></td><td><code>blake3Hash</code></td><td>Header hash</td></tr>
<tr><td><code>txs</code></td><td><code>Vec&lt;blake3Hash&gt;</code></td><td>Transaction hashes</td></tr>
<tr><td><code>metadata</code></td><td><code>Metadata</code></td><td>Additional block information</td></tr>
</tbody></table>
</div>
<h2 id="blockinfo"><a class="header" href="#blockinfo">BlockInfo</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>magic</code></td><td><code>u8</code></td><td>Magic bytes</td></tr>
<tr><td><code>header</code></td><td><code>Header</code></td><td>Header data</td></tr>
<tr><td><code>txs</code></td><td><code>Vec&lt;Transaction&gt;</code></td><td>Transaction payload</td></tr>
<tr><td><code>metadata</code></td><td><code>Metadata</code></td><td>Additional block information</td></tr>
<tr><td><code>sm</code></td><td><code>StreamletMetadata</code></td><td>Proposal information used by Streamlet consensus</td></tr>
</tbody></table>
</div>
<h2 id="metadata"><a class="header" href="#metadata">Metadata</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>proof</code></td><td><code>VRFOutput</code></td><td>Proof the stakeholder is the block owner</td></tr>
<tr><td><code>rand_seed</code></td><td><code>Seed</code></td><td>Random seed for the VRF</td></tr>
<tr><td><code>signature</code></td><td><code>Signature</code></td><td>Block owner signature</td></tr>
<tr><td><code>address</code></td><td><code>Address</code></td><td>Block owner address</td></tr>
</tbody></table>
</div>
<h2 id="streamlet-metadata"><a class="header" href="#streamlet-metadata">Streamlet Metadata</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>votes</code></td><td><code>Vec&lt;Vote&gt;</code></td><td>Epoch votes for the block</td></tr>
<tr><td><code>notarized</code></td><td><code>bool</code></td><td>Block notarization flag</td></tr>
<tr><td><code>finalized</code></td><td><code>bool</code></td><td>Block finalization flag</td></tr>
</tbody></table>
</div>
<h2 id="participant"><a class="header" href="#participant">Participant</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>public_key</code></td><td><code>PublicKey</code></td><td>Node public key</td></tr>
<tr><td><code>address</code></td><td><code>Address</code></td><td>Node wallet address</td></tr>
<tr><td><code>joined</code></td><td><code>u64</code></td><td>Slot node joined the network</td></tr>
<tr><td><code>voted</code></td><td><code>Option&lt;u64&gt;</code></td><td>Last slot node voted</td></tr>
<tr><td><code>quarantined</code></td><td><code>Option&lt;u64&gt;</code></td><td>Slot participant was quarantined by the node</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfi-node-architecture-dna"><a class="header" href="#darkfi-node-architecture-dna">DarkFi Node Architecture (DNA)</a></h1>
<p>The DarkFi ecosystem runs as a network of P2P nodes, where these nodes
interact with each other over specific programs (or layers). In this
section, we'll explain how each of the layers fit together and when
combined create a functioning network that becomes DarkFi.</p>
<p>The layers are organized as a bottom-up pyramid, much like the
DarkFi logo:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∖</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">d</span><span class="mord">/</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∖</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord">/</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∖</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord">/</span></span></span></span></span></p>
<p>We will start with the top-level daemon - <code>validatord</code> - which
serves as the consensus and data storage layer, then we will explain
<code>darkfid</code> and its communication with the layer above (<code>validatord</code>),
and the layer below (<code>drk</code>).</p>
<p>An abstract view of the network looks like the following:</p>
<pre><code>[drk] &lt;--&gt; [darkfid] &lt;--&gt; [validatord] &lt;-+
                                         |
[drk] &lt;--&gt; [darkfid] &lt;--&gt; [validatord] &lt;-+
</code></pre>
<h2 id="validatord"><a class="header" href="#validatord">validatord</a></h2>
<p><code>validatord</code> is the DarkFi consensus and data storage layer. Everyone
that runs a validator participates in the network as a data archive,
and is able to store incoming transactions, and relay them to
other validators over the P2P network and protocol. Additionally,
storing this data allows others to replicate it and participate in
the same way.</p>
<p>Provided there is a locked stake on a running validator, the node
can also participate in the Proof-of-Stake consensus, enabling the
ability to vote on incoming transactions rather than just relaying
(and validating) them.</p>
<p>In case the node is not participating in the consensus, it should still
relay incoming transactions to other (ideally consensus-participating)
validators in the network.</p>
<h3 id="inner-workings"><a class="header" href="#inner-workings">Inner workings</a></h3>
<p>In its database, <code>validatord</code> stores transactions and blocks that
have reached consensus. This is commonly known as a <em>&quot;blockchain&quot;</em>.
The blockchain is a shared state that is replicated between all
validators in the network.</p>
<p>Additionally, validators keep a pool of incoming transactions
and proposed blocks, which get validated and voted on by the
consensus-participating validators.</p>
<p>The lifetime of an incoming transaction (and block) is as follows:</p>
<ol>
<li>Wait for a transaction</li>
<li>Validate incoming transaction (and go back to 1. if invalid)</li>
<li>Broadcast transaction to other validators in the network</li>
<li>Other validators validate transaction (and go back to 1. if invalid)</li>
<li>Leader validates the state transition and proposes a block</li>
<li>Consensus-participating nodes validate the state transition and
vote on the proposed block if the state transition is valid.</li>
<li>If the block is confirmed, it is appended to the <em>blockchain</em> and
is replicated between all validators in the network.</li>
</ol>
<h2 id="darkfid"><a class="header" href="#darkfid">darkfid</a></h2>
<p><code>TODO: Initial sync and retrieving wallet state?</code></p>
<p><code>darkfid</code> is the client layer of DarkFi used for wallet management
and transaction broadcasting. The wallet keeps a history of balances,
<em>coins</em>, <em>nullifiers</em>, and <em>merkle roots</em> that are necessary in order
to create new transactions.</p>
<p>By design, <code>darkfid</code> is a light client, since <code>validatord</code> stores all
the blockchain data, and <code>darkfid</code> can simply query for anything it
is interested in. This allows us to avoid data duplication and simply
utilize our modular architecture. This also means that <code>darkfid</code> can
easily be replaced with more specific tooling, if need be.</p>
<h3 id="inner-workings-1"><a class="header" href="#inner-workings-1">Inner workings</a></h3>
<p>Using the P2P network and protocol, <code>darkfid</code> can subscribe to
<code>validatord</code> in order to receive new <em>nullifiers</em> and <em>merkle roots</em>
whenever a new block is confirmed. This allows <code>darkfid</code> to update
its local state and enables it to create new valid transactions.</p>
<p><code>darkfid</code> exposes a JSON-RPC endpoint for clients to interact with it.
This allows a number of things, such as: listing balances, creating
and submitting transactions, key management, and more.</p>
<p>When creating a new transactions, <code>darkfid</code> uses the local synced state
in order to create new <em>coins</em> and combine them in a transaction. This
transaction is then submitted to the above validator layer where the
transaction will get validated and voted on in order to be included
into a block.</p>
<h2 id="drk"><a class="header" href="#drk">drk</a></h2>
<p><code>drk</code> is a client tool that interacts with <code>darkfid</code> in a user-friendly
way and provides a command-line interface to the DarkFi network and
its functionality.</p>
<p>The interaction with <code>darkfid</code> is done over the JSON-RPC protocol
and communicates with the endpoint exposed by <code>darkfid</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anonymous-smart-contracts"><a class="header" href="#anonymous-smart-contracts">Anonymous Smart Contracts</a></h1>
<p>Every full node is a <strong>verifier</strong>.</p>
<p><strong>Prover</strong> is the person executing the smart contract function on their secret witness data.
They are also verifiers in our model.</p>
<p>Lets take a pseudocode smart contract:</p>
<pre><code>contract Dao {
    # 1: the DAO's global state
    dao_bullas = DaoBulla[]
    proposal_bullas = ProposalBulla[]
    proposal_nulls = ProposalNull[]

    # 2. a public smart contract function
    #    there can be many of these
    fn mint(...) {
        ...
    }

    ...
}
</code></pre>
<h2 id="global-smart-contract-state"><a class="header" href="#global-smart-contract-state">Global Smart Contract State</a></h2>
<p>Internally we represent this smart contract like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    // Corresponds to 1. above, the global state
    struct State {
        dao_bullas: Vec&lt;DaoBulla&gt;,
        proposal_bullas: Vec&lt;ProposalBulla&gt;,
        proposal_nulls: Vec&lt;ProposalNull&gt;
    }

    // Corresponds to 2. mint()
    mod mint {
        // Prover specific
        struct Builder {
            ...
            // secret witness values for prover
            ...
        }

        impl Builder {
            fn new(...) -&gt; Self {
                ...
            }

            fn build() -&gt; FuncCall {
                ...
            }
        }

        // Verifier code
        struct CallData {
            ...
            // contains the function call data
            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>There is a pipeline where the prover runs <code>Builder::build()</code> to create the <code>FuncCall</code> object that
is then broadcast to the verifiers through the p2p network.</p>
<p>The <code>CallData</code> usually is the public values exported from a ZK proof. Essentially it is the data
used by the verifier to check the function call for <code>DAO::mint()</code>.</p>
<h2 id="atomic-transactions"><a class="header" href="#atomic-transactions">Atomic Transactions</a></h2>
<p>Transactions represent several function call invocations that are atomic. If any function call fails,
the entire tx is rejected. Additionally some smart contracts might impose additional conditions
on the transaction's structure or other function calls (such as their call data).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Transaction {
    func_calls: Vec&lt;FuncCall&gt;
}
<span class="boring">}
</span></code></pre></pre>
<p>Function calls represent mutations of the current active state to a new state.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct FuncCall {
    contract_id: ContractId,
    func_id: FuncId,
    call_data: Box&lt;dyn Any&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>contract_id</code> corresponds to the top level module for the contract which
includes the global <code>State</code>.</p>
<p>The <code>func_id</code> of a function call corresponds to predefined objects in the submodules:</p>
<ul>
<li><code>Builder</code> creates the anonymized <code>CallData</code>. Ran by the prover.</li>
<li><code>CallData</code> is the parameters used by the anonymized function call invocation.
Verifiers have this.</li>
<li><code>state_transition()</code> that runs the function call on the current state using the <code>CallData</code>.</li>
<li><code>apply()</code> commits the update to the current state taking it to the next state.</li>
</ul>
<p>An example of a <code>contract_id</code> could represent <code>DAO</code> or <code>Money</code>. Examples of <code>func_id</code> could
represent <code>DAO::mint()</code> or <code>Money::transfer()</code>.</p>
<p>Each function call invocation is ran using its own <code>state_transition()</code> function.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    ...

    // DAO::mint() in the smart contract pseudocode
    mod mint {
        ...

        fn state_transition(states: &amp;StateRegistry, func_call_index: usize, parent_tx: &amp;Transaction) -&gt; Result&lt;Update&gt; {
            // we could also change the state_transition() function signature
            // so we pass the func_call itself in
            let func_call = parent_tx.func_calls[func_call_index];
            let call_data = func_call.call_data;
            // It's useful to have the func_call_index within parent_tx because
            // we might want to enforce that it appears at a certain index exactly.
            // So we know the tx is well formed.

            // we can elide this with macro magic
            assert_eq((&amp;**call_data).type_id(), TypeId::of::&lt;CallData&gt;());
            let func_call = func_call.call_data.downcast_ref::&lt;CallData&gt;();

            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>state_transition()</code> has access to the entire atomic transaction to enforce correctness. For example
chaining of function calls is used by the <code>DAO::exec()</code> smart contract function to execute moving money out
of the treasury using <code>Money::transfer()</code> within the same transaction.</p>
<p>Additionally <code>StateRegistry</code> gives smart contracts access to the global states of all smart contracts on the network,
which is needed for some contracts.</p>
<p>Note that during this step, the state is <em>not</em> modified. Modification happens after the <code>state_transition()</code> is run
for all function call invocations within the transaction. Assuming they all pass successfully, the updates are then
applied at the end. This ensures atomicity property of transactions.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    ...

    // DAO::mint() in the smart contract pseudocode
    mod mint {
        ...

        // StateRegistry is mutable
        fn apply(states: &amp;mut StateRegistry, update: Update) {
            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>The transaction verification pipeline roughly looks like this:</p>
<ol>
<li>Loop through all function call invocations within the transaction:
<ol>
<li>Lookup their respective <code>state_transition()</code> function based off their <code>contract_id</code> and <code>func_id</code>.
The <code>contract_id</code> and <code>func_id</code> corresponds to the contract and specific function, such as <code>DAO::mint()</code>.</li>
<li>Call the <code>state_transition()</code> function and store the update. Halt if this function fails.</li>
</ol>
</li>
<li>Loop through all updates
<ol>
<li>Lookup specific <code>apply()</code> function based off the <code>contract_id</code> and <code>func_id</code>.</li>
<li>Call <code>apply(update)</code> to finalize the change.</li>
</ol>
</li>
</ol>
<h2 id="parallelisation-techniques"><a class="header" href="#parallelisation-techniques">Parallelisation Techniques</a></h2>
<p>Since verification is done through <code>state_transition()</code> which returns an update that is then committed
to the state using <code>apply()</code>, we can verify all transactions in a block in parallel.</p>
<p>To enable calling another transaction within the same block (such as flashloans), we can add a special
depends field within the tx that makes a tx wait on another tx before being allowed to verify.
This causes a small deanonymization to occur but brings a massive scalability benefit
to the entire system.</p>
<p>ZK proof verification should be done automatically by the system. Any proof that fails marks the entire
tx as invalid, and the tx is discarded. This should also be parallelized.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="clients"><a class="header" href="#clients">Clients</a></h1>
<p>This section gives information on DarkFi's clients, such as darkfid and
cashierd. Currently this section offers documentation on the client's
RPC API.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfid-json-rpc-api"><a class="header" href="#darkfid-json-rpc-api">darkfid JSON-RPC API</a></h1>
<h2 id="blockchain-methods"><a class="header" href="#blockchain-methods">blockchain methods</a></h2>
<ul>
<li><a href="clients/darkfid_jsonrpc.html#blockchainget_slot"><code>blockchain.get_slot</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#blockchainmerkle_roots"><code>blockchain.merkle_roots</code></a></li>
</ul>
<h3 id="blockchainget_slot"><a class="header" href="#blockchainget_slot"><code>blockchain.get_slot</code></a></h3>
<p>Queries the blockchain database for a block in the given slot.
Returns a readable block upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_blockchain.rs#L22">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;blockchain.get_slot&quot;, &quot;params&quot;: [0], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: {...}, &quot;id&quot;: 1}
</code></pre>
<h3 id="blockchainmerkle_roots"><a class="header" href="#blockchainmerkle_roots"><code>blockchain.merkle_roots</code></a></h3>
<p>Queries the blockchain database for all available merkle roots.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_blockchain.rs#L55">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;blockchain.merkle_roots&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [..., ..., ...], &quot;id&quot;: 1}
</code></pre>
<h2 id="tx-methods"><a class="header" href="#tx-methods">tx methods</a></h2>
<ul>
<li><a href="clients/darkfid_jsonrpc.html#txtransfer"><code>tx.transfer</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#txsimulate"><code>tx.simulate</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#txbroadcast"><code>tx.broadcast</code></a></li>
</ul>
<h3 id="txtransfer"><a class="header" href="#txtransfer"><code>tx.transfer</code></a></h3>
<p>Transfer a given amount of some token to the given address.
Returns a transaction ID upon success.</p>
<ul>
<li><code>dest_addr</code> -&gt; Recipient's DarkFi address</li>
<li><code>token_id</code> -&gt; ID of the token to send</li>
<li><code>12345</code> -&gt; Amount in <code>u64</code> of the funds to send
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_tx.rs#L27">[src]</a></sup></li>
</ul>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;tx.transfer&quot;, &quot;params&quot;: [&quot;dest_addr&quot;, &quot;token_id&quot;, 12345], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID...&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="txsimulate"><a class="header" href="#txsimulate"><code>tx.simulate</code></a></h3>
<p>Simulate a network state transition with the given transaction.
Returns <code>true</code> if the transaction is valid, otherwise, a corresponding
error.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_tx.rs#L108">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;tx.simulate&quot;, &quot;params&quot;: [&quot;base58encodedTX&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="txbroadcast"><a class="header" href="#txbroadcast"><code>tx.broadcast</code></a></h3>
<p>Broadcast a given transaction to the P2P network.
The function will first simulate the state transition in order to see
if the transaction is actually valid, and in turn it will return an
error if this is the case. Otherwise, a transaction ID will be returned.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_tx.rs#L152">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;tx.broadcast&quot;, &quot;params&quot;: [&quot;base58encodedTX&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID...&quot;, &quot;id&quot;: 1}
</code></pre>
<h2 id="wallet-methods"><a class="header" href="#wallet-methods">wallet methods</a></h2>
<ul>
<li><a href="clients/darkfid_jsonrpc.html#walletkeygen"><code>wallet.keygen</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletget_addrs"><code>wallet.get_addrs</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletexport_keypair"><code>wallet.export_keypair</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletimport_keypair"><code>wallet.import_keypair</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletset_default_address"><code>wallet.set_default_address</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletget_balances"><code>wallet.get_balances</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletget_coins_valtok"><code>wallet.get_coins_valtok</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletget_merkle_path"><code>wallet.get_merkle_path</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#walletdecrypt_note"><code>wallet.decrypt_note</code></a></li>
</ul>
<h3 id="walletkeygen"><a class="header" href="#walletkeygen"><code>wallet.keygen</code></a></h3>
<p>Attempts to generate a new keypair and returns its address upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L30">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.keygen&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;1DarkFi...&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="walletget_addrs"><a class="header" href="#walletget_addrs"><code>wallet.get_addrs</code></a></h3>
<p>Fetches public keys by given indexes from the wallet and returns it in an
encoded format. <code>-1</code> is supported to fetch all available keys.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L50">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.get_addrs&quot;, &quot;params&quot;: [1, 2], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [&quot;foo&quot;, &quot;bar&quot;], &quot;id&quot;: 1}
</code></pre>
<h3 id="walletexport_keypair"><a class="header" href="#walletexport_keypair"><code>wallet.export_keypair</code></a></h3>
<p>Exports the given keypair index.
Returns the encoded secret key upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L116">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.export_keypair&quot;, &quot;params&quot;: [0], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;foobar&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="walletimport_keypair"><a class="header" href="#walletimport_keypair"><code>wallet.import_keypair</code></a></h3>
<p>Imports a given secret key into the wallet as a keypair.
Returns the public counterpart as the result upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L142">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.import_keypair&quot;, &quot;params&quot;: [&quot;foobar&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;pubfoobar&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="walletset_default_address"><a class="header" href="#walletset_default_address"><code>wallet.set_default_address</code></a></h3>
<p>Sets the default wallet address to the given index.
Returns <code>true</code> upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L181">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.set_default_address&quot;, &quot;params&quot;: [2], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="walletget_balances"><a class="header" href="#walletget_balances"><code>wallet.get_balances</code></a></h3>
<p>Queries the wallet for known tokens with active balances.
Returns a map of balances, indexed by the token ID.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L216">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.get_balances&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [{&quot;1Foobar...&quot;: 100}, {...}]&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="walletget_coins_valtok"><a class="header" href="#walletget_coins_valtok"><code>wallet.get_coins_valtok</code></a></h3>
<p>Queries the wallet for a coin containing given parameters (value, token_id, unspent),
and returns the entire row with the coin's data:
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L248">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.get_coins_valtok&quot;, &quot;params&quot;: [1234, &quot;F00b4r...&quot;, true], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [&quot;coin&quot;, &quot;data&quot;, ...], &quot;id&quot;: 1}
</code></pre>
<h3 id="walletget_merkle_path"><a class="header" href="#walletget_merkle_path"><code>wallet.get_merkle_path</code></a></h3>
<p>Query the state merkle tree for the merkle path of a given leaf position.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L285">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.get_merkle_path&quot;, &quot;params&quot;: [3], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [&quot;f091uf1...&quot;, &quot;081ff0h10w1h0...&quot;, ...], &quot;id&quot;: 1}
</code></pre>
<h3 id="walletdecrypt_note"><a class="header" href="#walletdecrypt_note"><code>wallet.decrypt_note</code></a></h3>
<p>Try to decrypt a given encrypted note with the secret keys
found in the wallet.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_wallet.rs#L311">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;wallet.decrypt_note&quot;, params&quot;: [ciphertext], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;base58_encoded_plain_note&quot;, &quot;id&quot;: 1}
</code></pre>
<h2 id="misc-methods"><a class="header" href="#misc-methods">misc methods</a></h2>
<ul>
<li><a href="clients/darkfid_jsonrpc.html#ping"><code>ping</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#clock"><code>clock</code></a></li>
</ul>
<h3 id="ping"><a class="header" href="#ping"><code>ping</code></a></h3>
<p>Returns a <code>pong</code> to the <code>ping</code> request.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_misc.rs#L16">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;ping&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;pong&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="clock"><a class="header" href="#clock"><code>clock</code></a></h3>
<p>Returns current system clock in <code>Timestamp</code> format.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/rpc_misc.rs#L25">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;clock&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: {...}, &quot;id&quot;: 1}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="cashierd-json-rpc-api"><a class="header" href="#cashierd-json-rpc-api">cashierd JSON-RPC API</a></h1>
<ul>
<li><a href="clients/cashierd_jsonrpc.html#deposit"><code>deposit</code></a></li>
<li><a href="clients/cashierd_jsonrpc.html#withdraw"><code>withdraw</code></a></li>
<li><a href="clients/cashierd_jsonrpc.html#features"><code>features</code></a></li>
</ul>
<h3 id="deposit"><a class="header" href="#deposit"><code>deposit</code></a></h3>
<p>Executes a deposit request given <code>network</code> and <code>token_id</code>.
Returns the address where the deposit shall be transferred to.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L396">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;deposit&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;Ht5G1RhkcKnpLVLMhqJc5aqZ4wYUEbxbtZwGCVbgU7DL&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="withdraw"><a class="header" href="#withdraw"><code>withdraw</code></a></h3>
<p>Executes a withdraw request given <code>network</code>, <code>token_id</code>, <code>publickey</code>
and <code>amount</code>. <code>publickey</code> is supposed to correspond to <code>network</code>.
Returns the transaction ID of the processed withdraw.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L527">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;withdraw&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;, &quot;amount&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="features"><a class="header" href="#features"><code>features</code></a></h3>
<p>Returns supported cashier features, like network, listening ports, etc.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L614">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;features&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: {&quot;network&quot;: [&quot;btc&quot;, &quot;sol&quot;]}, &quot;id&quot;: 1}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="faucetd-json-rpc-api"><a class="header" href="#faucetd-json-rpc-api">faucetd JSON-RPC API</a></h1>
<ul>
<li><a href="clients/faucetd_jsonrpc.html#airdrop"><code>airdrop</code></a></li>
</ul>
<h3 id="airdrop"><a class="header" href="#airdrop"><code>airdrop</code></a></h3>
<p>Processes an airdrop request and airdrops requested token and amount to address.
Returns the transaction ID upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/faucetd/src/main.rs#L184">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;airdrop&quot;, &quot;params&quot;: [&quot;1DarkFi...&quot;, 1.42, &quot;1F00b4r...&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID&quot;, &quot;id&quot;: 1}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zkas"><a class="header" href="#zkas">zkas</a></h1>
<p>zkas is a compiler for the Halo2 zkVM language used in
<a href="https://github.com/darkrenaissance/darkfi">DarkFi</a>.</p>
<p>The current implementation found in the DarkFi repository inside
<a href="https://github.com/darkrenaissance/darkfi/tree/master/src/zkas"><code>src/zkas</code></a>
is the reference compiler and language implementation. It is a
toolchain consisting of a lexer, parser, static and semantic analyzers,
and a binary code compiler.</p>
<p>The
<a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/zkas/src/main.rs"><code>main.rs</code></a>
file shows how this toolchain is put together to produce binary code
from source code.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zkas-bincode"><a class="header" href="#zkas-bincode">zkas bincode</a></h1>
<p>The bincode design for zkas is the compiled code in the form of a
binary blob, that can be read by a program and fed into the VM.</p>
<p>Our programs consist of four sections: <code>constant</code>, <code>literal</code>,
<code>contract</code>, and <code>circuit</code>. Our bincode represents the
same. Additionally, there is an optional section called <code>.debug</code>
which can hold debug info related to the binary.</p>
<p>We currently keep all variables on one stack, and literals on another
stack. Therefore before each <code>STACK_INDEX</code> we prepend <code>STACK_TYPE</code> so
the VM is able to know which stack it should do lookup from.</p>
<p>The compiled binary blob has the following layout:</p>
<pre><code>MAGIC_BYTES
BINARY_VERSION
.constant
CONSTANT_TYPE CONSTANT_NAME 
CONSTANT_TYPE CONSTANT_NAME 
...
.literal
LITERAL
LITERAL
...
.contract
WITNESS_TYPE
WITNESS_TYPE
...
.circuit
OPCODE ARG_NUM STACK_TYPE STACK_INDEX ... STACK_TYPE STACK_INDEX
OPCODE ARG_NUM STACK_TYPE STACK_INDEX ... STACK_TYPE STACK_INDEX
...
.debug
TBD
</code></pre>
<p>Integers in the binary are encoded using variable-integer encoding.
See <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/util/serial.rs"><code>serial.rs</code></a>
for our Rust implementation.</p>
<h2 id="sections"><a class="header" href="#sections">Sections</a></h2>
<h3 id="magic_bytes"><a class="header" href="#magic_bytes"><code>MAGIC_BYTES</code></a></h3>
<p>The magic bytes are the file signature consisting of four bytes used
to identify the zkas binary code. They consist of:</p>
<blockquote>
<p><code>0x0b</code> <code>0x01</code> <code>0xb1</code> <code>0x35</code></p>
</blockquote>
<h3 id="binary_version"><a class="header" href="#binary_version"><code>BINARY_VERSION</code></a></h3>
<p>The binary code also contains the binary version to allow parsing
potential different formats in the future.</p>
<blockquote>
<p><code>0x02</code></p>
</blockquote>
<h3 id="constant"><a class="header" href="#constant"><code>.constant</code></a></h3>
<p>The constants in the <code>.constant</code> section are declared with their type
and name, so that the VM knows how to search for the builtin constant
and add it to the stack.</p>
<h3 id="literal"><a class="header" href="#literal"><code>.literal</code></a></h3>
<p>The literals in the <code>.literal</code> section are currently unsigned integers
that get parsed into a <code>u64</code> type inside the VM. In the future this
could be extended with signed integers, and strings.</p>
<h3 id="contract"><a class="header" href="#contract"><code>.contract</code></a></h3>
<p>The <code>.contract</code> section holds the circuit witness values in the form
of <code>WITNESS_TYPE</code>. Their stack index is incremented for each witness
as they're kept in order like in the source file. The witnesses
that are of the same type as the circuit itself (typically <code>Base</code>)
will be loaded into the circuit as <em>private values</em> using the Halo2
<code>load_private</code> API.</p>
<h3 id="circuit"><a class="header" href="#circuit"><code>.circuit</code></a></h3>
<p>The <code>.circuit</code> section holds the procedural logic of the ZK proof.
In here we have statements with opcodes that are executed as
understood by the VM. The statements are in the form of:</p>
<blockquote>
<p><code>OPCODE ARG_NUM STACK_TYPE STACK_INDEX ... STACK_TYPE STACK_INDEX</code></p>
</blockquote>
<p>where:</p>
<div class="table-wrapper"><table><thead><tr><th>Element</th><th>Description</th></tr></thead><tbody>
<tr><td><code>OPCODE</code></td><td>The opcode we wish to execute</td></tr>
<tr><td><code>ARG_NUM</code></td><td>The number of arguments given to this opcode</td></tr>
<tr><td></td><td>(Note the VM should be checking the correctness of this as well)</td></tr>
<tr><td><code>STACK_TYPE</code></td><td>Type of the stack to do lookup from (variables or literals)</td></tr>
<tr><td></td><td>(This is prepended to every <code>STACK_INDEX</code>)</td></tr>
<tr><td><code>STACK_INDEX</code></td><td>The location of the argument on the stack.</td></tr>
<tr><td></td><td>(This is supposed to be repeated <code>ARG_NUM</code> times)</td></tr>
</tbody></table>
</div>
<p>In case an opcode has a return value, the value shall be pushed to
the stack and become available for later references.</p>
<h3 id="debug"><a class="header" href="#debug"><code>.debug</code></a></h3>
<p>TBD</p>
<h2 id="syntax-reference"><a class="header" href="#syntax-reference">Syntax Reference</a></h2>
<h3 id="variable-types"><a class="header" href="#variable-types">Variable Types</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>EcPoint</code></td><td>Elliptic Curve Point.</td></tr>
<tr><td><code>EcFixedPoint</code></td><td>Elliptic Curve Point (constant).</td></tr>
<tr><td><code>EcFixedPointBase</code></td><td>Elliptic Curve Point in Base Field (constant).</td></tr>
<tr><td><code>Base</code></td><td>Base Field Element.</td></tr>
<tr><td><code>BaseArray</code></td><td>Base Field Element Array.</td></tr>
<tr><td><code>Scalar</code></td><td>Scalar Field Element.</td></tr>
<tr><td><code>ScalarArray</code></td><td>Scalar Field Element Array.</td></tr>
<tr><td><code>MerklePath</code></td><td>Merkle Tree Path.</td></tr>
<tr><td><code>Uint32</code></td><td>Unsigned 32 Bit Integer.</td></tr>
<tr><td><code>Uint64</code></td><td>Unsigned 64 Bit Integer.</td></tr>
</tbody></table>
</div>
<h3 id="literal-types"><a class="header" href="#literal-types">Literal Types</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>Uint64</code></td><td>Unsigned 64 Bit Integer.</td></tr>
</tbody></table>
</div>
<h3 id="opcodes"><a class="header" href="#opcodes">Opcodes</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Opcode</th><th>Description</th></tr></thead><tbody>
<tr><td><code>EcAdd</code></td><td>Elliptic Curve Addition.</td></tr>
<tr><td><code>EcMul</code></td><td>Elliptic Curve Multiplication.</td></tr>
<tr><td><code>EcMulBase</code></td><td>Elliptic Curve Multiplication with <code>Base</code>.</td></tr>
<tr><td><code>EcMulShort</code></td><td>Elliptic Curve Multiplication with a u64 wrapped in a <code>Scalar</code>.</td></tr>
<tr><td><code>EcGetX</code></td><td>Get X Coordinate of Elliptic Curve Point.</td></tr>
<tr><td><code>EcGetY</code></td><td>Get Y Coordinate of Elliptic Curve Point.</td></tr>
<tr><td><code>PoseidonHash</code></td><td>Poseidon Hash of N Elements.</td></tr>
<tr><td><code>MerkleRoot</code></td><td>Compute a Merkle Root.</td></tr>
<tr><td><code>BaseAdd</code></td><td><code>Base</code> Addition.</td></tr>
<tr><td><code>BaseMul</code></td><td><code>Base</code> Multiplication.</td></tr>
<tr><td><code>BaseSub</code></td><td><code>Base</code> Subtraction.</td></tr>
<tr><td><code>WitnessBase</code></td><td>Witness an unsigned integer into a <code>Base</code>.</td></tr>
<tr><td><code>RangeCheck</code></td><td>Perform a (either 64bit or 253bit) range check over some <code>Base</code></td></tr>
<tr><td><code>LessThan</code></td><td>Compare if <code>Base</code> a is lesser than <code>Base</code> b</td></tr>
<tr><td><code>ConstrainInstance</code></td><td>Constrain a <code>Base</code> to a Circuit's Public Input.</td></tr>
</tbody></table>
</div>
<h3 id="built-in-opcode-wrappers"><a class="header" href="#built-in-opcode-wrappers">Built-in Opcode Wrappers</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Opcode</th><th>Function</th><th>Return</th></tr></thead><tbody>
<tr><td><code>EcAdd</code></td><td><code>ec_add(EcPoint a, EcPoint b)</code></td><td><code>(EcPoint c)</code></td></tr>
<tr><td><code>EcMul</code></td><td><code>ec_mul(EcPoint a, EcPoint c)</code></td><td><code>(EcPoint c)</code></td></tr>
<tr><td><code>EcMulBase</code></td><td><code>ec_mul_base(Base a, EcFixedPointBase b)</code></td><td><code>(EcPoint c)</code></td></tr>
<tr><td><code>EcMulShort</code></td><td><code>ec_mul_short(Base a, EcFixedPointShort b)</code></td><td><code>(EcPoint c)</code></td></tr>
<tr><td><code>EcGetX</code></td><td><code>ec_get_x(EcPoint a)</code></td><td><code>(Base x)</code></td></tr>
<tr><td><code>EcGetY</code></td><td><code>ec_get_y(EcPoint a)</code></td><td><code>(Base y)</code></td></tr>
<tr><td><code>PoseidonHash</code></td><td><code>poseidon_hash(Base a, ..., Base n)</code></td><td><code>(Base h)</code></td></tr>
<tr><td><code>MerkleRoot</code></td><td><code>merkle_root(Uint32 i, MerklePath p, Base a)</code></td><td><code>(Base r)</code></td></tr>
<tr><td><code>BaseAdd</code></td><td><code>base_add(Base a, Base b)</code></td><td><code>(Base c)</code></td></tr>
<tr><td><code>BaseMul</code></td><td><code>base_mul(Base a, Base b)</code></td><td><code>(Base c)</code></td></tr>
<tr><td><code>BaseSub</code></td><td><code>base_sub(Base a, Base b)</code></td><td><code>(Base c)</code></td></tr>
<tr><td><code>WitnessBase</code></td><td><code>witness_base(123)</code></td><td><code>(Base a)</code></td></tr>
<tr><td><code>RangeCheck</code></td><td><code>range_check(64, Base a)</code></td><td><code>()</code></td></tr>
<tr><td><code>LessThan</code></td><td><code>less_than(Base a, Base b)</code></td><td><code>()</code></td></tr>
<tr><td><code>ConstrainInstance</code></td><td><code>constrain_instance(Base a)</code></td><td><code>()</code></td></tr>
</tbody></table>
</div>
<h2 id="decoding-the-bincode"><a class="header" href="#decoding-the-bincode">Decoding the bincode</a></h2>
<p>An example decoder implementation can be found in zkas'
<a href="https://github.com/darkrenaissance/darkfi/blob/master/src/zkas/decoder.rs"><code>decoder.rs</code></a>
module.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>This section holds practical and real-world examples of the use for
zkas.</p>
<ul>
<li><a href="zkas/examples/sapling.html">Sapling payment scheme</a></li>
<li><a href="zkas/examples/voting.html">Anonymous voting</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sapling-payment-scheme"><a class="header" href="#sapling-payment-scheme">Sapling payment scheme</a></h1>
<p>Sapling is a type of transaction which hides both the sender and
receiver data, as well as the amount transacted. This means it allows
a fully private transaction between two addresses.</p>
<p>Generally, the Sapling payment scheme consists of two ZK proofs -
<strong>mint</strong> and <strong>burn</strong>. We use the mint proof to create a new <em>coin</em>
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, and we use the burn proof to spend a previously minted <em>coin</em>.</p>
<h2 id="mint-proof"><a class="header" href="#mint-proof">Mint proof</a></h2>
<pre><code>constant &quot;Mint&quot; {
	EcFixedPointShort VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
	EcFixedPointBase NULLIFIER_K,
}

contract &quot;Mint&quot; {
	Base pub_x,
	Base pub_y,
	Base value,
	Base token,
	Base serial,
	Base coin_blind,
	Scalar value_blind,
	Scalar token_blind,
}

circuit &quot;Mint&quot; {
	# Poseidon hash of the coin
	C = poseidon_hash(pub_x, pub_y, value, token, serial, coin_blind);
	constrain_instance(C);

	# Pedersen commitment for coin's value
	vcv = ec_mul_short(value, VALUE_COMMIT_VALUE);
	vcr = ec_mul(value_blind, VALUE_COMMIT_RANDOM);
	value_commit = ec_add(vcv, vcr);
	# Since the value commit is a curve point, we fetch its coordinates
	# and constrain them:
	value_commit_x = ec_get_x(value_commit);
	value_commit_y = ec_get_y(value_commit);
	constrain_instance(value_commit_x);
	constrain_instance(value_commit_y);

	# Pedersen commitment for coin's token ID
	tcv = ec_mul_base(token, NULLIFIER_K);
	tcr = ec_mul(token_blind, VALUE_COMMIT_RANDOM);
	token_commit = ec_add(tcv, tcr);
	# Since token_commit is also a curve point, we'll do the same
	# coordinate dance:
	token_commit_x = ec_get_x(token_commit);
	token_commit_y = ec_get_y(token_commit);
	constrain_instance(token_commit_x);
	constrain_instance(token_commit_y);

	# At this point we've enforced all of our public inputs.
}
</code></pre>
<p>As you can see, the <code>Mint</code> proof basically consists of three
operations.  First one is hashing the <em>coin</em> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, and after that,
we create <em>Pedersen commitments</em><sup class="footnote-reference"><a href="#1">1</a></sup> for both the coin's <strong>value</strong>
and the coin's <strong>token ID</strong>. On top of the zkas code, we've declared
two constant values that we are going to use for multiplication in
the commitments.</p>
<p>The <code>constrain_instance</code> call can take any of our assigned variables
and enforce a <em>public input</em>. Public inputs are an array (or vector)
of revealed values used by verifiers to verify a zero knowledge
proof. In the above case of the Mint proof, since we have five calls to
<code>constrain_instance</code>, we would also have an array of five elements that
represent these public inputs. The array's order <strong>must match</strong> the
order of the <code>constrain_instance</code> calls since they will be constrained
by their index in the array (which is incremented for every call).</p>
<p>In other words, the vector of public inputs could look like this:</p>
<pre><code>let public_inputs = vec![
    coin,
    *value_coords.x(),
    *value_coords.y(),
    *token_coords.x(),
    *token_coords.y(),
];
</code></pre>
<p>And then the Verifier uses these public inputs to verify a given zero
knowledge proof.</p>
<h3 id="coin"><a class="header" href="#coin">Coin</a></h3>
<p>During the <strong>Mint</strong> phase we create a new coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, which is bound
to the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>. The coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> is publicly revealed on the
blockchain and added to the Merkle tree.</p>
<p>Let <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> be the coin's value, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> be the token ID, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span> be the unique
serial number for the coin, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be a random blinding value. We
create a commitment (hash) of these elements and produce the coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>
in zero-knowledge:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>An interesting thing to keep in mind is that this commitment is
extensible, so one could fit an arbitrary amount of different
attributes inside it.</p>
<h3 id="value-and-token-commitments"><a class="header" href="#value-and-token-commitments">Value and token commitments</a></h3>
<p>To have some value <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> for our coin, we ensure it's greater than
zero, and then we can create a Pedersen commitment <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
is the blinding factor for the commitment, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are
two predefined generators:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>The token ID can be thought of as an attribute we append to our coin
so we can have a differentiation of assets we are working with. In
practice, this allows us to work with different tokens, using the
same zero-knowledge proof circuit. For this token ID, we can also
build a Pedersen commitment <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> is the token ID, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
is the blinding factor, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are predefined generators:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="pseudo-code"><a class="header" href="#pseudo-code">Pseudo-code</a></h2>
<p>Knowing this we can extend our pseudo-code and build the
before-mentioned public inputs for the circuit:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let bincode = include_bytes!(&quot;../proof/mint.zk.bin&quot;);
    let zkbin = ZkBinary::decode(bincode)?;

    // ======
    // Prover
    // ======

    // Witness values
    let value = 42;
    let token_id = pallas::Base::random(&amp;mut OsRng);
    let value_blind = pallas::Scalar::random(&amp;mut OsRng);
    let token_blind = pallas::Scalar::random(&amp;mut OsRng);
    let serial = pallas::Base::random(&amp;mut OsRng);
    let coin_blind = pallas::Base::random(&amp;mut OsRng);
    let public_key = PublicKey::random(&amp;mut OsRng);
    let coords = public_key.0.to_affine().coordinates().unwrap();

    let prover_witnesses = vec![
        Witness::Base(Value::known(*coords.x())),
        Witness::Base(Value::known(*coords.y())),
        Witness::Base(Value::known(pallas::Base::from(value))),
        Witness::Base(Value::known(token_id)),
        Witness::Base(Value::known(serial)),
        Witness::Base(Value::known(coin_blind)),
        Witness::Scalar(Value::known(value_blind)),
        Witness::Scalar(Value::known(token_blind)),
    ];

    // Create the public inputs
    let msgs = [*coords.x(), *coords.y(), pallas::Base::from(value), token_id, serial, coin_blind];
    let coin = poseidon::Hash::&lt;_, poseidon::P128Pow5T3, poseidon::ConstantLength&lt;6&gt;, 3, 2&gt;::init()
        .hash(msgs);

    let value_commit = pedersen_commitment_u64(value, value_blind);
    let value_coords = value_commit.to_affine().coordinates().unwrap();

    let token_commit = pedersen_commitment_base(token_id, token_blind);
    let token_coords = token_commit.to_affine().coordinates().unwrap();

    let public_inputs =
        vec![coin, *value_coords.x(), *value_coords.y(), *token_coords.x(), *token_coords.y()];

    // Create the circuit
    let circuit = ZkCircuit::new(prover_witnesses, zkbin.clone());

    let proving_key = ProvingKey::build(13, &amp;circuit);
    let proof = Proof::create(&amp;proving_key, &amp;[circuit], &amp;public_inputs, &amp;mut OsRng)?;

    // ========
    // Verifier
    // ========

    // Construct empty witnesses
    let verifier_witnesses = empty_witnesses(&amp;zkbin);

    // Create the circuit
    let circuit = ZkCircuit::new(verifier_witnesses, zkbin);

    let verifying_key = VerifyingKey::build(13, &amp;circuit);
    proof.verify(&amp;verifying_key, &amp;public_inputs)?;
<span class="boring">}
</span></code></pre></pre>
<h2 id="burn-1"><a class="header" href="#burn-1">Burn</a></h2>
<pre><code>constant &quot;Burn&quot; {
	EcFixedPointShort VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
	EcFixedPointBase NULLIFIER_K,
}

contract &quot;Burn&quot; {
	Base secret,
	Base serial,
	Base value,
	Base token,
	Base coin_blind,
	Scalar value_blind,
	Scalar token_blind,
	Uint32 leaf_pos,
	MerklePath path,
	Base signature_secret,
}

circuit &quot;Burn&quot; {
	# Poseidon hash of the nullifier
	nullifier = poseidon_hash(secret, serial);
	constrain_instance(nullifier);

	# Pedersen commitment for coin's value
	vcv = ec_mul_short(value, VALUE_COMMIT_VALUE);
	vcr = ec_mul(value_blind, VALUE_COMMIT_RANDOM);
	value_commit = ec_add(vcv, vcr);
	# Since value_commit is a curve point, we fetch its coordinates
	# and constrain them:
	value_commit_x = ec_get_x(value_commit);
	value_commit_y = ec_get_y(value_commit);
	constrain_instance(value_commit_x);
	constrain_instance(value_commit_y);

	# Pedersen commitment for coin's token ID
	tcv = ec_mul_base(token, NULLIFIER_K);
	tcr = ec_mul(token_blind, VALUE_COMMIT_RANDOM);
	token_commit = ec_add(tcv, tcr);
	# Since token_commit is also a curve point, we'll do the same
	# coordinate dance:
	token_commit_x = ec_get_x(token_commit);
	token_commit_y = ec_get_y(token_commit);
	constrain_instance(token_commit_x);
	constrain_instance(token_commit_y);

	# Coin hash
	pub = ec_mul_base(secret, NULLIFIER_K);
	pub_x = ec_get_x(pub);
	pub_y = ec_get_y(pub);
	C = poseidon_hash(pub_x, pub_y, value, token, serial, coin_blind);

	# Merkle root
	root = merkle_root(leaf_pos, path, C);
	constrain_instance(root);

	# Finally, we derive a public key for the signature and
	# constrain its coordinates:
	signature_public = ec_mul_base(signature_secret, NULLIFIER_K);
	signature_x = ec_get_x(signature_public);
	signature_y = ec_get_y(signature_public);
	constrain_instance(signature_x);
	constrain_instance(signature_y);

	# At this point we've enforced all of our public inputs.
}
</code></pre>
<p>The <code>Burn</code> proof consists of operations similar to the <code>Mint</code> proof,
with the addition of a <em>Merkle root</em><sup class="footnote-reference"><a href="#2">2</a></sup> calculation. In the same
manner, we are doing a Poseidon hash instance, we're building Pedersen
commitments for the value and token ID, and finally we're doing a
public key derivation.</p>
<p>In this case, our vector of public inputs could look like:</p>
<pre><code>let public_inputs = vec![
    nullifier,
    *value_coords.x(),
    *value_coords.y(),
    *token_coords.x(),
    *token_coords.y(),
    merkle_root,
    *sig_coords.x(),
    *sig_coords.y(),
];
</code></pre>
<h3 id="nullifier"><a class="header" href="#nullifier">Nullifier</a></h3>
<p>When we spend the coin, we must ensure that the value of the coin
cannot be double spent. We call this the <em>Burn</em> phase. The process
relies on a nullifier <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, which we create using the secret key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>
for the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> and a unique random serial <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span>. Nullifiers
are unique per coin and prevent double spending:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="merkle-root"><a class="header" href="#merkle-root">Merkle root</a></h3>
<p>We check that the merkle root corresponds to a coin which is in the
Merkle tree <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<h3 id="value-and-token-commitments-1"><a class="header" href="#value-and-token-commitments-1">Value and token commitments</a></h3>
<p>Just like we calculated these for the <code>Mint</code> proof, we do the same
here:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="public-key-derivation"><a class="header" href="#public-key-derivation">Public key derivation</a></h2>
<p>We check that the secret key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> corresponds to a public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>.
Usually, we do public key derivation my multiplying our secret key
with a genera tor <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span>, which results in a public key:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">G</span></span></span></span></span></p>
<h2 id="pseudo-code-1"><a class="header" href="#pseudo-code-1">Pseudo-code</a></h2>
<p>Knowing this we can extend our pseudo-code and build the
before-mentioned public inputs for the circuit:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let bincode = include_bytes!(&quot;../proof/burn.zk.bin&quot;);
    let zkbin = ZkBinary::decode(bincode)?;

    // ======
    // Prover
    // ======

    // Witness values
    let value = 42;
    let token_id = pallas::Base::random(&amp;mut OsRng);
    let value_blind = pallas::Scalar::random(&amp;mut OsRng);
    let token_blind = pallas::Scalar::random(&amp;mut OsRng);
    let serial = pallas::Base::random(&amp;mut OsRng);
    let coin_blind = pallas::Base::random(&amp;mut OsRng);
    let secret = SecretKey::random(&amp;mut OsRng);
    let sig_secret = SecretKey::random(&amp;mut OsRng);

    // Build the coin
    let coin2 = {
        let coords = PublicKey::from_secret(secret).0.to_affine().coordinates().unwrap();
        let messages =
            [*coords.x(), *coords.y(), pallas::Base::from(value), token_id, serial, coin_blind];

        poseidon::Hash::&lt;_, poseidon::P128Pow5T3, poseidon::ConstantLength&lt;6&gt;, 3, 2&gt;::init()
            .hash(messages)
    };

    // Fill the merkle tree with some random coins that we want to witness,
    // and also add the above coin.
    let mut tree = BridgeTree::&lt;MerkleNode, 32&gt;::new(100);
    let coin0 = pallas::Base::random(&amp;mut OsRng);
    let coin1 = pallas::Base::random(&amp;mut OsRng);
    let coin3 = pallas::Base::random(&amp;mut OsRng);

    tree.append(&amp;MerkleNode(coin0));
    tree.witness();
    tree.append(&amp;MerkleNode(coin1));
    tree.append(&amp;MerkleNode(coin2));
    let leaf_pos = tree.witness().unwrap();
    tree.append(&amp;MerkleNode(coin3));
    tree.witness();

    let root = tree.root(0).unwrap();
    let merkle_path = tree.authentication_path(leaf_pos, &amp;root).unwrap();
    let leaf_pos: u64 = leaf_pos.into();

    let prover_witnesses = vec![
        Witness::Base(Value::known(secret.0)),
        Witness::Base(Value::known(serial)),
        Witness::Base(Value::known(pallas::Base::from(value))),
        Witness::Base(Value::known(token_id)),
        Witness::Base(Value::known(coin_blind)),
        Witness::Scalar(Value::known(value_blind)),
        Witness::Scalar(Value::known(token_blind)),
        Witness::Uint32(Value::known(leaf_pos.try_into().unwrap())),
        Witness::MerklePath(Value::known(merkle_path.try_into().unwrap())),
        Witness::Base(Value::known(sig_secret.0)),
    ];

    // Create the public inputs
    let nullifier = [secret.0, serial];
    let nullifier =
        poseidon::Hash::&lt;_, poseidon::P128Pow5T3, poseidon::ConstantLength&lt;2&gt;, 3, 2&gt;::init()
            .hash(nullifier);

    let value_commit = pedersen_commitment_u64(value, value_blind);
    let value_coords = value_commit.to_affine().coordinates().unwrap();

    let token_commit = pedersen_commitment_base(token_id, token_blind);
    let token_coords = token_commit.to_affine().coordinates().unwrap();

    let sig_pubkey = PublicKey::from_secret(sig_secret);
    let sig_coords = sig_pubkey.0.to_affine().coordinates().unwrap();

    let merkle_root = tree.root(0).unwrap();

    let public_inputs = vec![
        nullifier,
        *value_coords.x(),
        *value_coords.y(),
        *token_coords.x(),
        *token_coords.y(),
        merkle_root.0,
        *sig_coords.x(),
        *sig_coords.y(),
    ];

    // Create the circuit
    let circuit = ZkCircuit::new(prover_witnesses, zkbin.clone());

    let proving_key = ProvingKey::build(13, &amp;circuit);
    let proof = Proof::create(&amp;proving_key, &amp;[circuit], &amp;public_inputs, &amp;mut OsRng)?;

    // ========
    // Verifier
    // ========

    // Construct empty witnesses
    let verifier_witnesses = empty_witnesses(&amp;zkbin);

    // Create the circuit
    let circuit = ZkCircuit::new(verifier_witnesses, zkbin);

    let verifying_key = VerifyingKey::build(13, &amp;circuit);
    proof.verify(&amp;verifying_key, &amp;public_inputs)?;
<span class="boring">}
</span></code></pre></pre>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>See section 3: <em>The Commitment Scheme</em> of Torben Pryds Pedersen's
<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-46766-1_9.pdf">paper on Non-Interactive and
Information-Theoretic Secure Verifiable Secret
Sharing</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree on Wikipedia</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anonymous-voting"><a class="header" href="#anonymous-voting">Anonymous voting</a></h1>
<p>Anonymous voting<sup class="footnote-reference"><a href="#1">1</a></sup> is a type of voting process where users can
vote without revealing their identity, by proving they are accepted
as valid voters.</p>
<p>The proof enables user privacy and allows for fully anonymous voting.</p>
<p>The starting point is a Merkle proof<sup class="footnote-reference"><a href="#2">2</a></sup>, which efficiently proves that
a voter's key belongs to a Merkle tree. However, using this proof alone
would allow the organizer of a process to correlate each vote envelope
with its voter's key on the database, so votes wouldn't be secret.</p>
<h2 id="vote-proof"><a class="header" href="#vote-proof">Vote proof</a></h2>
<pre><code>constant &quot;Vote&quot; {
	EcFixedPointShort VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
	EcFixedPointBase NULLIFIER_K,
}

contract &quot;Vote&quot; {
	Base process_id_0,
	Base process_id_1,
	Base secret_key,
	Base vote,
	Scalar vote_blind,
	Uint32 leaf_pos,
	MerklePath path,
}

circuit &quot;Vote&quot; {
	# Nullifier hash
	process_id = poseidon_hash(process_id_0, process_id_1);
	nullifier = poseidon_hash(secret_key, process_id);
	constrain_instance(nullifier);

	# Public key derivation and hashing
	public_key = ec_mul_base(secret_key, NULLIFIER_K);
	public_x = ec_get_x(public_key);
	public_y = ec_get_y(public_key);
	pk_hash = poseidon_hash(public_x, public_y);

	# Merkle root
	root = merkle_root(leaf_pos, path, pk_hash);
	constrain_instance(root);

	# Pedersen commitment for vote
	vcv = ec_mul_short(vote, VALUE_COMMIT_VALUE);
	vcr = ec_mul(vote_blind, VALUE_COMMIT_RANDOM);
	vote_commit = ec_add(vcv, vcr);
	# Since vote_commit is a curve point, we fetch its coordinates
	# and constrain_them:
	vote_commit_x = ec_get_x(vote_commit);
	vote_commit_y = ec_get_y(vote_commit);
	constrain_instance(vote_commit_x);
	constrain_instance(vote_commit_y);
}
</code></pre>
<p>Our proof consists of four main operation. First we are hashing the
<em>nullifier</em> using our secret key and the hashed process ID. Next,
we derive our public key and hash it. Following, we take this hash
and create a Merkle proof that it is indeed contained in the given
Merkle tree. And finally, we create a <em>Pedersen commitment</em><sup class="footnote-reference"><a href="#3">3</a></sup>
for the vote choice itself.</p>
<p>Our vector of public inputs can look like this:</p>
<pre><code>let public_inputs = vec![
    nullifier,
    merkle_root,
    *vote_coords.x(),
    *vote_coords.y(),
]
</code></pre>
<p>And then the Verifier uses these public inputs to verify the given
zero-knowledge proof.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Specification taken from <a href="https://docs.vocdoni.io/architecture/protocol/anonymous-voting/zk-census-proof.html">vocdoni franchise proof</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree on Wikipedia</a></p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>See section 3: <em>The Commitment Scheme</em> of Torben Pryds Pedersen's
<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-46766-1_9.pdf">paper on Non-Interactive and
Information-Theoretic Secure Verifiable Secret
Sharing</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="miscellaneous-tools"><a class="header" href="#miscellaneous-tools">Miscellaneous tools</a></h1>
<p>This section documents some miscellaneous tools provided in the DarkFi
ecosystem.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="vanityaddr"><a class="header" href="#vanityaddr">vanityaddr</a></h1>
<p>A tool for Vanity address generation for DarkFi keypairs. Given some
prefix, the tool will bruteforce secret keys to find one which, when
derived into an address, starts with a given prefix.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<pre><code>vanityaddr 0.3.0
Vanity address generation tool for DarkFi keypairs.

USAGE:
    vanityaddr [OPTIONS] &lt;PREFIX&gt;

ARGS:
    &lt;PREFIX&gt;    Prefix to search (must start with 1)

OPTIONS:
    -c                  Should the search be case-sensitive
    -h, --help          Print help information
    -t &lt;THREADS&gt;        Number of threads to use (defaults to number of available CPUs)
    -V, --version       Print version information
</code></pre>
<p>We can use the tool in our command line:</p>
<pre><code>% vanityaddr 1Foo
[00:00:05] 53370 attempts
</code></pre>
<p>And the program will start crunching numbers. After a period of time,
we will get JSON output containing an address, secret key, and the
number of attempts it took to find the secret key.</p>
<pre><code>{&quot;address&quot;:&quot;1FoomByzBBQywKaeBB5XPkAm5eCboh8K4CBhBe9uKbJm3kEiCS&quot;,&quot;attempts&quot;:78418,&quot;secret&quot;:&quot;0x16545da4a401adcd035ef51c8040acf5f4f1c66c0dd290bb5ec9e95991ae3615&quot;}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="p2p-irc"><a class="header" href="#p2p-irc">P2P IRC</a></h1>
<p>In DarkFi, we organize our communication using resilient and
censorship-resistant infrastructure. For chatting, <code>ircd</code> is a
peer-to-peer implementation of an IRC server in which any user can
participate anonymously using any IRC frontend and by running the
IRC daemon. <code>ircd</code> uses the DarkFi P2P engine to synchronize chats
between hosts.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi 
% cd darkfi
% make BINS=ircd
% sudo make install BINS=ircd
</code></pre>
<p>Follow the instructions in the
<a href="https://darkrenaissance.github.io/darkfi/index.html">README</a> to ensure
you have all the necessary dependenices.</p>
<h2 id="usage-darkfi-network"><a class="header" href="#usage-darkfi-network">Usage (DarkFi Network)</a></h2>
<p>Upon installing <code>ircd</code> as described above, the preconfigured defaults
will allow you to connect to the network and start chatting with the
rest of the DarkFi community.</p>
<p>First, try to start <code>ircd</code> from your command-line so it can spawn its
configuration file in place. The preconfigured defaults will autojoin
you to the <code>#dev</code> channel, where the community is most active and
talks about DarkFi development.</p>
<pre><code class="language-shell">% ircd
</code></pre>
<p>After running it for the first time, <code>ircd</code> will create a configuration
file you can review and potentially edit. It might be useful if you
want to add other channels you want to autojoin (like <code>#philosophy</code>
and <code>#memes</code>), or if you want to set a shared secret for some channel
in order for it to be encrypted between its participants.</p>
<p>When done, you can run <code>ircd</code> for the second time in order for it to
connect to the network and start participating in the P2P protocol:</p>
<pre><code class="language-shell">% ircd
</code></pre>
<h2 id="clients-1"><a class="header" href="#clients-1">Clients</a></h2>
<h3 id="weechat"><a class="header" href="#weechat">Weechat</a></h3>
<p>In this section, we'll briefly cover how to use the <a href="https://github.com/weechat/weechat">Weechat IRC
client</a> to connect and chat with
<code>ircd</code>.</p>
<p>Normally, you should be able to install weechat using your
distribution's package manager. If not, have a look at the weechat
<a href="https://github.com/weechat/weechat">git repository</a> for instructions
on how to install it on your computer.</p>
<p>Once installed, we can configure a new server which will represent our
<code>ircd</code> instance. First, start weechat, and in its window - run the
following commands (there is an assumption that <code>irc_listen</code> in the
<code>ircd</code> config file is set to <code>127.0.0.1:6667</code>):</p>
<pre><code>/server add darkfi localhost/6667 -autoconnect
/save
/quit
</code></pre>
<p>This will set up the server, save the settings, and exit weechat.
You are now ready to begin using the chat. Simply start weechat
and everything should work.</p>
<h2 id="usage-local-deployment"><a class="header" href="#usage-local-deployment">Usage (Local Deployment)</a></h2>
<p>These steps below are only for developers who wish to make a testing
deployment. The previous sections are sufficient to join the chat.</p>
<h3 id="seed-node"><a class="header" href="#seed-node">Seed Node</a></h3>
<p>First you must run a seed node. The seed node is a static host which
nodes can connect to when they first connect to the network. The
<code>seed_session</code> simply connects to a seed node and runs <code>protocol_seed</code>,
which requests a list of addresses from the seed node and disconnects
straight after receiving them.</p>
<p>The first time you run the program, a config file will be created in
<code>~/.config/darkfi</code> if your are using Linux or in 
<code>~/Library/Application Support/darkfi/</code> on MacOS. 
You must specify an inbound accept address in your config file to configure a seed node:</p>
<pre><code class="language-toml">## P2P accept addresses
inbound=[&quot;127.0.0.1:11001&quot;]
</code></pre>
<p>Note that the above config doesn't specify an external address since
the seed node shouldn't be advertised in the list of connectable
nodes. The seed node does not participate as a normal node in the
p2p network. It simply allows new nodes to discover other nodes in
the network during the bootstrapping phase.</p>
<h3 id="inbound-node"><a class="header" href="#inbound-node">Inbound Node</a></h3>
<p>This is a node accepting inbound connections on the network but which
is not making any outbound connections.</p>
<p>The external addresses are important and must be correct.</p>
<p>To run an inbound node, your config file must contain the following
info:</p>
<pre><code class="language-toml">## P2P accept addresses
inbound=[&quot;127.0.0.1:11002&quot;]

## P2P external addresses
external_addr=[&quot;127.0.0.1:11002&quot;]

## Seed nodes to connect to 
seeds=[&quot;127.0.0.1:11001&quot;]
</code></pre>
<h3 id="outbound-node"><a class="header" href="#outbound-node">Outbound Node</a></h3>
<p>This is a node which has 8 outbound connection slots and no inbound
connections.  This means the node has 8 slots which will actively
search for unique nodes to connect to in the p2p network.</p>
<p>In your config file:</p>
<pre><code class="language-toml">## Connection slots
outbound_connections=8

## Seed nodes to connect to 
seeds=[&quot;127.0.0.1:11001&quot;]
</code></pre>
<h3 id="attaching-the-irc-frontend"><a class="header" href="#attaching-the-irc-frontend">Attaching the IRC Frontend</a></h3>
<p>Assuming you have run the above 3 commands to create a small model
testnet, and both inbound and outbound nodes above are connected,
you can test them out using weechat.</p>
<p>To create separate weechat instances, use the <code>--dir</code> command:</p>
<pre><code>weechat --dir /tmp/a/
weechat --dir /tmp/b/
</code></pre>
<p>Then in both clients, you must set the option to connect to temporary
servers:</p>
<pre><code>/set irc.look.temporary_servers on
</code></pre>
<p>Finally you can attach to the local IRCd instances:</p>
<pre><code>/connect localhost/6667
/connect localhost/6668
</code></pre>
<p>And send messages to yourself.</p>
<h3 id="running-a-fullnode"><a class="header" href="#running-a-fullnode">Running a Fullnode</a></h3>
<p>See the script <code>script/run_node.sh</code> for an example of how to deploy
a full node which does seed session synchronization, and accepts both
inbound and outbound connections.</p>
<h2 id="global-buffer"><a class="header" href="#global-buffer">Global Buffer</a></h2>
<p>Copy <a href="https://github.com/narodnik/weechat-global-buffer/blob/main/buffclone.py">this script</a> to <code>~/.weechat/python/autoload/</code>,
and you will create a single buffer which aggregates messages from all channels. It's useful to monitor activity
from all channels without needing to flick through them.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="tau"><a class="header" href="#tau">Tau</a></h1>
<p>Encrypted tasks management app using peer-to-peer network.<br />
Multiple users can collaborate by working on the same tasks, 
and all users will have synced tasks.</p>
<h2 id="install-1"><a class="header" href="#install-1">Install</a></h2>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi 
% cd darkfi
% make BINS=&quot;taud tau&quot;
% sudo make install &quot;BINS=taud tau&quot;
</code></pre>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>To run your own instance check <a href="misc/tau.html#local-deployment">Local Deployment</a></p>
<pre><code class="language-shell">% tau --help 
</code></pre>
<pre><code>tau 0.3.0

USAGE:
    tau [OPTIONS] [FILTERS]... [SUBCOMMAND]

ARGS:
    &lt;FILTERS&gt;...    Search filters (zero or more)                                 

OPTIONS:
    -e, --endpoint &lt;ENDPOINT&gt;    taud JSON-RPC endpoint [default: tcp://127.0.0.1:23330]
    -h, --help                   Print help information
    -v                           Increase verbosity (-vvv supported)
    -V, --version                Print version information

SUBCOMMANDS:
    add        Add a new task.                                                    
    comment    Set or Get comment for task(s)
    export     Export tasks to a specified directory
    help       Print this message or the help of the given subcommand(s)
    import     Import tasks from a specified directory
    info       Get all data about selected task(s)
    list       List tasks
    log        Log drawdown
    modify     Modify/Edit an existing task
    open       Open task(s)
    pause      Pause task(s)
    start      Start task(s)
    stop       Stop task(s)
    switch     Switch workspace
</code></pre>
<pre><code class="language-shell">% tau [SUBCOMMAND] --help
</code></pre>
<h3 id="quick-start"><a class="header" href="#quick-start">Quick start</a></h3>
<h4 id="add-tasks"><a class="header" href="#add-tasks">Add tasks</a></h4>
<pre><code class="language-shell">% tau add Review tau usage desc:description	# will add a new task named
%						# &quot;Review tau usage&quot; with
%						# &quot;description&quot; in its desc filed
% tau add Second task assign:dave 	# will add a new task and assign it
%					# to &quot;dave&quot;.
%					# Note: not having &quot;desc:&quot; key
% 					# will pop up your OS editor
%					# configured in $EDITOR env var,
%					# this is recommended for
%					# formatting reasons and
%					# will be used through this demo.
% tau add Third task project:tau rank:1.1
% tau add Fourth task assign:dave project:tau due:1509 rank:2.5
% tau add Five
</code></pre>
<h4 id="list-tasks"><a class="header" href="#list-tasks">List tasks</a></h4>
<pre><code class="language-shell">% tau				# all non-stop tasks
% tau list			# all non-stop tasks
% tau 1-3			# tasks 1 to 3
% tau 1,2 state:open		# tasks 1 and 2 and if they are open
% tau rank:gt:2			# all tasks that have rank greater than 2
% tau due.not:today		# all tasks that thier due date is not today
% tau due.after:0909		# all tasks that thier due date is after September 9th
% tau assign:dave		# tasks that assign field is &quot;dave&quot;
</code></pre>
<h4 id="filtering-tasks"><a class="header" href="#filtering-tasks">Filtering tasks</a></h4>
<p>Note: mod commands are: start, open, pause, stop and modify.</p>
<p>Note: All filters from the previous section could work with mod commands.</p>
<pre><code class="language-shell">% tau 5 stop			# will stop task 5
% tau 1,3 start			# start 1 and 3
% tau 2 pause			# pause 2
% tau 2,4 modify due:2009	# edit due to September in tasks 2 and 4 
% tau 1-4 modify project:tau	# edit project to tau in tasks 1,2,3 and 4
% tau state:pause open		# open paused tasks
% tau 3 info			# show information about task 3 (does not modify)
</code></pre>
<h4 id="comments"><a class="header" href="#comments">Comments</a></h4>
<pre><code class="language-shell">% tau 1 comment &quot;content foo bar&quot;	# will add a comment to task 1
% tau 3 comment				# will show comments on task 3 
</code></pre>
<h4 id="log-drawdown"><a class="header" href="#log-drawdown">Log drawdown</a></h4>
<pre><code class="language-shell">% tau log 0922			# will list assignees of stopped tasks
% tau log 0922 [&lt;Assignee&gt;]	# will draw a heatmap of stopped tasks for [Assignee]
</code></pre>
<h4 id="export-and-import"><a class="header" href="#export-and-import">Export and Import</a></h4>
<pre><code class="language-shell">% tau export ~/example_dir	# will save tasks json files to the path
% tau import ~/example_dir	# will reload saved json files from the path
</code></pre>
<h4 id="switch-workspace"><a class="header" href="#switch-workspace">Switch workspace</a></h4>
<pre><code class="language-shell">% tau switch darkfi	# darkfi workspace needs to be configured in config file
</code></pre>
<h2 id="local-deployment"><a class="header" href="#local-deployment">Local Deployment</a></h2>
<h3 id="seed-node-1"><a class="header" href="#seed-node-1">Seed Node</a></h3>
<p>First you must run a seed node. The seed node is a static host which nodes can
connect to when they first connect to the network. The <code>seed_session</code> simply
connects to a seed node and runs <code>protocol_seed</code>, which requests a list of
addresses from the seed node and disconnects straight after receiving them.</p>
<pre><code>in config file:

	## P2P accept addresses
	inbound=[&quot;127.0.0.1:11001&quot;] 
</code></pre>
<p>Note that the above config doesn't specify an external address since the
seed node shouldn't be advertised in the list of connectable nodes. The seed
node does not participate as a normal node in the p2p network. It simply allows
new nodes to discover other nodes in the network during the bootstrapping phase.</p>
<h3 id="inbound-node-1"><a class="header" href="#inbound-node-1">Inbound Node</a></h3>
<p>This is a node accepting inbound connections on the network but which is not
making any outbound connections.</p>
<p>The external addresses are important and must be correct.</p>
<pre><code>in config file:
	
	## P2P accept addresses
	inbound=[&quot;127.0.0.1:11002&quot;]
	
	## P2P external addresses
	external_addr=[&quot;127.0.0.1:11002&quot;]

	## Seed nodes to connect to 
	seeds=[&quot;127.0.0.1:11001&quot;]
</code></pre>
<h3 id="outbound-node-1"><a class="header" href="#outbound-node-1">Outbound Node</a></h3>
<p>This is a node which has 8 outbound connection slots and no inbound connections.
This means the node has 8 slots which will actively search for unique nodes to
connect to in the p2p network.</p>
<pre><code>in config file:

	## Connection slots
	outbound_connections=8

	## Seed nodes to connect to 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="hashchain"><a class="header" href="#hashchain">HashChain</a></h1>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="structures"><a class="header" href="#structures">Structures</a></h1>
<h2 id="eventid"><a class="header" href="#eventid">EventId</a></h2>
<p>Hash of <code>Event</code> </p>
<pre><code>type EventId = [u8; 32];	
</code></pre>
<h2 id="eventaction"><a class="header" href="#eventaction">EventAction</a></h2>
<p>The <code>Event</code> could have many actions according to the underlying data.</p>
<pre><code>enum EventAction { ... };	
</code></pre>
<h3 id="actions-types"><a class="header" href="#actions-types">Actions types</a></h3>
<h4 id="privmsg"><a class="header" href="#privmsg">Privmsg</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>nickname</td><td>String</td><td>The nickname for the sender (must be less than 32 chars)</td></tr>
<tr><td>target</td><td>String</td><td>The target for the <code>Privmsg</code> (recipient)</td></tr>
<tr><td>message</td><td>String</td><td>The <code>Privmsg</code>'s content</td></tr>
</tbody></table>
</div>
<h2 id="event"><a class="header" href="#event">Event</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>previous_event_hash</td><td><code>EventId</code></td><td>Hash of the previous <code>Event</code></td></tr>
<tr><td>Action</td><td><code>EventAction</code></td><td><code>Event</code>'s action</td></tr>
<tr><td>Timestamp</td><td>u64</td><td><code>Event</code>'s timestamp</td></tr>
<tr><td>read_confirms</td><td>u8</td><td>A confirmation counter</td></tr>
</tbody></table>
</div>
<h2 id="eventnode"><a class="header" href="#eventnode">EventNode</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>parent</td><td>Option&lt;<code>EventId</code>&gt;</td><td>Only current root has this set to None</td></tr>
<tr><td>Event</td><td><code>Event</code></td><td>The <code>Event</code> itself</td></tr>
<tr><td>Children</td><td>Vec&lt;<code>EventId</code>&gt;</td><td>The <code>Event</code>s which has parent as this <code>Event</code> hash</td></tr>
</tbody></table>
</div>
<h2 id="model"><a class="header" href="#model">Model</a></h2>
<p>The <code>Model</code> consist of chains(<code>EventNodes</code>) structured as a tree, each chain has Event-based
list. To maintain strict order in chain, Each <code>Event</code> dependent on the hash of the previous <code>Event</code>. 
All the chains share a root <code>Event</code> to preserve the tree structure. </p>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>current_root</td><td><code>EventId</code></td><td>The root <code>Event</code> for the tree</td></tr>
<tr><td>orphans</td><td>HashMap&lt;<code>EventId</code>, <code>Event</code>&gt;</td><td>Recently added <code>Event</code>s</td></tr>
<tr><td>event_map</td><td>HashMap&lt;<code>EventId</code>, <code>EventNode</code>&gt;</td><td>The actual tree</td></tr>
<tr><td>events_queue</td><td><code>EventsQueue</code></td><td>Communication channel</td></tr>
</tbody></table>
</div>
<h2 id="view"><a class="header" href="#view">View</a></h2>
<p>The <code>View</code> check the <code>Model</code> for new <code>Event</code>s, then dispatch these <code>Event</code>s to the clients. </p>
<p><code>Event</code>s are sorted according to the timestamp attached to each <code>Event</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>seen</td><td>HashMap&lt;<code>EventId</code>, <code>Event</code>&gt;</td><td>A list of <code>Event</code>s</td></tr>
</tbody></table>
</div>
<h2 id="eventsqueue"><a class="header" href="#eventsqueue">EventsQueue</a></h2>
<p>The <code>EventsQueue</code> used to transport the event from <code>Model</code> to <code>View</code>.</p>
<p>The <code>Model</code> fill The <code>EventsQueue</code> with the new <code>Event</code>, while the <code>View</code> keep
fetching <code>Event</code>s from queue continuously.</p>
<h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>Tau using Model–view software architecture. All the operations, main data structures, 
and handling messages from network protocol, happen in the <code>Model</code> side. 
While keeping the <code>View</code> independent of the <code>Model</code> and focusing on getting update 
from it continuously.</p>
<h2 id="add-new-event"><a class="header" href="#add-new-event">Add new Event</a></h2>
<p>Once receiving new <code>Event</code> from the network protocol, the <code>Event</code> will be add to the
orphans list. </p>
<p>After the ancestor for the new orphan gets found, The orphan <code>Event</code> will be add to the chain
according to its ancestor.</p>
<p>For example, in the <em> Example1 </em> below, An <code>Event</code> add to the first chain if
its previous hash is Event-A1</p>
<h2 id="remove-old-leaves"><a class="header" href="#remove-old-leaves">Remove old leaves</a></h2>
<p>Remove leaves which are too far from the head leaf(the leaf in the longest chain).</p>
<p>The depth difference from the common ancestor between a leaf to be removed and a head leaf 
must be greater than <code>MAX_DEPTH</code>. </p>
<h2 id="update-the-root"><a class="header" href="#update-the-root">Update the root</a></h2>
<p>Finding the highest common ancestor for the leaves and assign it as the root
for the tree.</p>
<p>The highest common ancestor must have height greater than <code>MAX_HEIGHT</code>.</p>
<p><img src="misc/hashchain/../../assets/mv_event.png" alt="data structure" /></p>
<p>Example1</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="network-protocol"><a class="header" href="#network-protocol">Network Protocol</a></h1>
<p>The protocol check that <code>Event</code>s have properly broadcasted through the
network before adding <code>Event</code>s to the <code>Model</code>. </p>
<p>The read_confirms inside each <code>Event</code> indicate how many times the <code>Event</code> has 
been read from other nodes in the network.</p>
<p>The protocol classify the Events by their state:</p>
<pre><code>Unread: read_confirms &lt; `MAX_CONFIMRS` 
Read: 	read_confirms &gt;= `MAX_CONFIMRS` 
</code></pre>
<h2 id="invid"><a class="header" href="#invid">InvId</a></h2>
<pre><code>type InvId = u64;
</code></pre>
<h2 id="invitem"><a class="header" href="#invitem">InvItem</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>Id</td><td><code>InvId</code></td><td>Unique generated integer</td></tr>
<tr><td>Hash</td><td><code>EventId</code></td><td>Hash of Event</td></tr>
</tbody></table>
</div>
<h2 id="inv"><a class="header" href="#inv">Inv</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>Invs</td><td>Vec&lt;<code>InvItem</code>&gt;</td><td>A list of <code>InvItem</code></td></tr>
</tbody></table>
</div>
<h3 id="receiving-an-inv-message"><a class="header" href="#receiving-an-inv-message">Receiving an <code>Inv</code> message</a></h3>
<p>An <code>Inv</code> message is a confirmation from a node in the network that the <code>Event</code>
has been read.</p>
<p>Confirmation for an <code>Event</code> not exist in the <code>UnreadEvents</code> list, 
The protocol send a <code>GetData</code> message to request the missing <code>Event</code>.</p>
<p>The protocol update the <code>Event</code> in the <code>UnreadEvents</code> list by increasing the
read_confirms by one.</p>
<p>The state for updated <code>Event</code> change to read when the read_confirms exceed
<code>MAX_CONFIMRS</code>, Then the <code>Event remove from the </code>UnreadEvents<code>list and add to the</code>Model`. </p>
<p>The protocol rebroadcast the received <code>Inv</code> to the network.</p>
<h3 id="sending-an-inv-message"><a class="header" href="#sending-an-inv-message">Sending an <code>Inv</code> message</a></h3>
<p>On receiving an <code>Event</code> with unread status from the network, The protocol send back 
an <code>Inv</code> message to confirm that the <code>Event</code> has been read.</p>
<h2 id="getdata"><a class="header" href="#getdata">GetData</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>events</td><td>Vec&lt;<code>EventId</code>&gt;</td><td>A list of <code>EventId</code></td></tr>
</tbody></table>
</div>
<h3 id="receiving-a-getdata-message"><a class="header" href="#receiving-a-getdata-message">Receiving a <code>GetData</code> message</a></h3>
<p>The protocol search in both <code>Model</code> and <code>UnreadEvents</code> for requested <code>Event</code>s
in <code>GetData</code> message.</p>
<h2 id="unreadevents"><a class="header" href="#unreadevents">UnreadEvents</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>Messages</td><td>HashMap&lt;<code>EventId</code>, <code>Event</code>&gt;</td><td>Hold all the <code>Event</code>s that have broadcasted to other nodes but haven't confirmed yet</td></tr>
</tbody></table>
</div>
<h3 id="add-new-event-to-unreadevents"><a class="header" href="#add-new-event-to-unreadevents">Add new <code>Event</code> to <code>UnreadEvents</code></a></h3>
<p>To add an <code>Event</code> to <code>UnreadEvents</code>, the protocol first must check the validity of
<code>Event</code>. </p>
<p>The <code>Event</code> is not valid in the network if it's too far in the future from now,
or too far in the past from now.</p>
<h3 id="updating-unreadevents-list"><a class="header" href="#updating-unreadevents-list">Updating <code>UnreadEvents</code> list</a></h3>
<p>The protocol continually broadcast unread <code>Event</code> to the network 
after a certain period of time(<code>SEND_UNREAD_EVENTS_INTERVAL</code>), 
Until the state of <code>Event</code> updated to read.</p>
<h2 id="syncevent"><a class="header" href="#syncevent">SyncEvent</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>Leaves</td><td>Vec&lt;<code>EventId</code>&gt;</td><td>hash of <code>Event</code>s</td></tr>
</tbody></table>
</div>
<h3 id="synchronization"><a class="header" href="#synchronization">Synchronization</a></h3>
<p>To achieve complete synchronization between nodes, the protocol send a
<code>SyncEvent</code> message every 2 seconds to other nodes in the network.</p>
<p>The <code>SyncEvent</code> contains the hashes of <code>Event</code>s set in the leaves of <code>Model</code>'s tree.</p>
<p>On receiving <code>SyncEvent</code> message, The leaves in <code>SyncEvent</code> should match the 
leaves in the <code>Model</code>'s tree, Otherwise the protocol send <code>Event</code>s which are the childern of
<code>Event</code>s in <code>SyncEvent</code> </p>
<h2 id="seen"><a class="header" href="#seen">Seen<ObjectId></a></h2>
<p>This used to prevent receiving duplicate Objects.
The list will contains only 2^16 ids.</p>
<div class="table-wrapper"><table><thead><tr><th>Description</th><th>Data Type</th><th>Comments</th></tr></thead><tbody>
<tr><td>Ids</td><td>Vec<ObjectId></td><td>Contains objects ids</td></tr>
</tbody></table>
</div>
<h2 id="receiving-a-new-event"><a class="header" href="#receiving-a-new-event">Receiving a new <code>Event</code></a></h2>
<p>The new received <code>Event</code> with unread status add to the <code>UnreadEvents</code> buffer after
increasing the read_confirms by one. </p>
<p>The <code>Event</code> with read status add to the <code>Model</code>.</p>
<p>The protocol broadcast the received <code>Event</code> to the network again, to ensure every nodes
in the network get the Event.</p>
<h2 id="sending-an-event"><a class="header" href="#sending-an-event">Sending an <code>Event</code></a></h2>
<p>A new created <code>Event</code> has unread status with read_confirms equal to 0.</p>
<p>The protocol broadcast the <code>Event</code> to the network after adding it to the
<code>UnreadEvents</code>.</p>
<h2 id="add-new-event-to-model"><a class="header" href="#add-new-event-to-model">Add new <code>Event</code> to <code>Model</code></a></h2>
<p>For the <code>Event</code> to be successfully add to the <code>Model</code>, the protocol check if
the previous <code>Event</code>'s hash inside the <code>Event</code> is exist in the <code>Model</code>.</p>
<p>In case the check for previous <code>Event</code> failed The protocol 
send a <code>GetData</code> message requesting the previous <code>Event</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkwiki"><a class="header" href="#darkwiki">Darkwiki</a></h1>
<p>Collaborative wiki using peer-to-peer network and raft consensus.</p>
<h2 id="install-2"><a class="header" href="#install-2">Install</a></h2>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi
% cd darkfi
% make BINS=&quot;darkwiki darkwikid&quot;
% sudo make install BINS=&quot;darkwikid darkwiki&quot;
</code></pre>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<p>1 - Once Darkwiki get installed, darkwiki daemon must run in the background:</p>
<pre><code class="language-shell">% darkwikid
</code></pre>
<p>2 - To update <code>synchronized directory</code> (default ~/darkwiki) and receive new documents from the network:</p>
<pre><code class="language-shell">% darkwiki update
</code></pre>
<blockquote>
<p><strong><em>NOTE:</em></strong>  The <code>synchronized directory</code> path can be changed from the config file in ~/.config/darkfi/darkwiki.toml</p>
</blockquote>
<p>3 - After add/edit a document in ~/darkwiki, the changes will be published by running
<code>update</code> command:</p>
<pre><code class="language-shell">% darkwiki update
</code></pre>
<p>4 - For restore files having local changes to the original text: </p>
<pre><code class="language-shell">% darkwiki resotre
</code></pre>
<p>5 - For both <code>restore</code> and <code>update</code> commands, the flag <code>--dry-run</code> can show the changes without applying/publishing the patches</p>
<pre><code class="language-shell">% darkwiki update --dry-run
</code></pre>
<p>6 - Both <code>restore</code> and <code>update</code> commands are accepting passing the files names instead of updating/restoring all the documents in ~/darkwiki</p>
<pre><code class="language-shell">% darkwiki update file1.md file2.md 
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="dnetview"><a class="header" href="#dnetview">Dnetview</a></h1>
<p>A simple tui to explore darkfi ircd network topology.</p>
<p>dnetview displays: </p>
<ol>
<li>all active nodes</li>
<li>outgoing, incoming and manual sessions</li>
<li>each associated connection and recent messages.</li>
</ol>
<p>dnetview is based on the design-pattern Model, View, Controller. We
create a logical separation between the underlying data structure or
Model; the ui rendering aspect which is the View; and the Controller or
game engine that makes everything run.</p>
<h2 id="install-3"><a class="header" href="#install-3">Install</a></h2>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi 
% cd darkfi
% make BINS=dnetview
</code></pre>
<h2 id="usage-3"><a class="header" href="#usage-3">Usage</a></h2>
<p>Run dnetview as follows:</p>
<pre><code class="language-shell">dnetview -v
</code></pre>
<p>On first run, dnetview will create a config file in .config/darkfi. You
must manually enter the RPC ports of the nodes you want to connect to
and title them as you see fit.</p>
<p>Dnetview creates a logging file in /tmp/dnetview.log. To see json data
and other debug info, tail the file like so:</p>
<pre><code class="language-shell">tail -f /tmp/dnetview.log
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="learn"><a class="header" href="#learn">Learn</a></h1>
<p>This section contains learning resources related to DarkFi.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="research"><a class="header" href="#research">Research</a></h1>
<p>DarkFi maintains a public resource of zero-knowledge and math research
in the <a href="learn/../../../script/research">script/research</a> directory of
the repo.</p>
<p>It features simple sage implementations of zero-knowledge algorithms
and math primitives, including but not limited to:</p>
<ul>
<li><a href="learn/../../../script/research/halo/halo">Halo</a></li>
<li><a href="learn/../../../script/research/groth16">Groth16</a></li>
<li><a href="learn/../../../script/research/poseidon">Poseidon hash</a></li>
<li><a href="learn/../../../script/research/bltprf">Bulletproofs</a></li>
<li><a href="learn/../../script/research/rsa_accum.sage">RSA accumulators</a></li>
<li><a href="learn/../../script/research/finite_fields">Finite fields</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zero-knowledge-explainer"><a class="header" href="#zero-knowledge-explainer">Zero-knowledge explainer</a></h1>
<p>We start with this algorithm as an example:</p>
<pre><code class="language-python">def foo(w, a, b):
    if w:
        return a * b
    else:
        return a + b
</code></pre>
<p>ZK code consists of lines of constraints. It has no concept of
branching conditionals or loops.</p>
<p>So our first task is to flatten (convert) the above code to a linear
equation that can be evaluated in ZK.</p>
<p>Consider an interesting fact. For any value <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>, then
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> if and only if <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>.</p>
<p>In our code above <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> is a binary value. It's value is either <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>
or <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>. We make use of this fact by the following:</p>
<ol>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> when <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> when <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>. If <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> then the expression is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>.</li>
</ol>
<p>So we can rewrite <code>foo(w, a, b)</code> as the mathematical function</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">ab</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></p>
<p>We now can convert this expression to a constraint system.</p>
<p>ZK statements take the form of:
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7306em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7306em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">)</span></span></span></span></span></p>
<p>More succinctly as:
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>These statements are converted into polynomials of the form:
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> is the target polynomial and in our case will be
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span>. <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> is the cofactor polynomial. The
statement says that the polynomial <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> has roots
(is equal to zero) at the points when <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span></span></span></span></span>.</p>
<p>Earlier we wrote our mathematical statement which we will now convert
to constraints.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">ab</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></p>
<p>Rearranging the equation, we note that:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">ab</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">ab</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></p>
<p>Swapping and rearranging, our final statement becomes
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>. Represented in ZK as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></span></p>
<p>The last line is a boolean constraint that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> is either <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> or <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> by
enforcing that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> (re-arranged this is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span>).</p>
<div class="table-wrapper"><table><thead><tr><th>Line</th><th>L(x)</th><th>R(x)</th><th>O(x)</th></tr></thead><tbody>
<tr><td>1</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></td></tr>
<tr><td>2</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></td></tr>
<tr><td>3</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mclose">)</span></span></span></span></td></tr>
</tbody></table>
</div>
<p>Because of how the polynomials are created during the setup phase, you
must supply them with the correct variables that satisfy these
constraints, so that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> (line 1),
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> (line 2) and
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> (line 3).</p>
<p>Each one of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> is supplied a list of
(constant coefficient, variable value) pairs.</p>
<p>In bellman library, the constant is a fixed value of type <code>Scalar</code>.
The variable is a type called <code>Variable</code>. These are the values fed
into <code>lc0</code> (the 'left' polynomial), <code>lc1</code> (the 'right' polynomial),
and <code>lc2</code> (the 'out' polynomial).</p>
<p>In our example we had a function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span> where for example <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span>.
The verifier does not know the variables <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>
and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> which are <em>allocated</em> by the prover as <em>variables</em>. However
the verifier does know the coefficients (which are of the <code>Scalar</code>
type) shown in the table above. In our example they only either <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>
or <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span>, but can also be other constant values.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct LinearCombination&lt;Scalar: PrimeField&gt;(Vec&lt;(Variable, Scalar)&gt;);
<span class="boring">}
</span></code></pre></pre>
<p>It is important to note that each one of the left, right and out
registers is simply a list of tuples of (constant coefficient,
variable value).</p>
<p>When we wish to add a constant value, we use the variable called
<code>~one</code> (which is always the first automatically allocated variable in
bellman at index 0). Therefore we end up adding our constant <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> to
the <code>LinearCombination</code> as <code>(c, ~one)</code>.</p>
<p>Any other non-constant value, we wish to add to our constraint system
<em>must</em> be allocated as a variable. Then the variable is added to the
<code>LinearCombination</code>. So in our example, we will allocate
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>, getting back <code>Variable</code> objects which we then add to
the left lc, right lc or output lc.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="dchat-writing-a-p2p-app"><a class="header" href="#dchat-writing-a-p2p-app">Dchat: Writing a p2p app</a></h1>
<p>This tutorial will teach you how to deploy an app on DarkFi's p2p network.</p>
<p>We will create a terminal-based p2p chat app called dchat that we run
in two different instances: an inbound and outbound node called Alice
and Bob. Alice takes a message from <code>stdin</code> and broadcasts it to the
p2p network. When Bob receives the message on on the p2p network it is
displayed his terminal.</p>
<p>Dchat will showcase some key concepts that you'll need to develop on
the p2p network, in particular:</p>
<ul>
<li>Understanding inbound, outbound and seed nodes.</li>
<li>Writing and registering a custom <code>Protocol</code>.</li>
<li>Creating and subscribing to a custom <code>Message</code> type.</li>
</ul>
<p>The source code for this tutorial can be found at
<a href="https://github.com/darkrenaissance/darkfi/tree/master/example/dchat">example/dchat</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="part-1-deploying-the-network"><a class="header" href="#part-1-deploying-the-network">Part 1: Deploying the network</a></h1>
<p>We'll start by deploying a local version of the p2p network. This will
introduce a number of key concepts:</p>
<ul>
<li>p2p daemons</li>
<li>Inbound, outbound, manual and seed nodes</li>
<li>Understanding <code>Sessions</code></li>
<li><code>p2p.start()</code>, <code>p2p.run()</code> and <code>p2p.stop()</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<p>We'll create a new cargo directory and add DarkFi to our <code>Cargo.toml</code>,
like so:</p>
<pre><code>[package]
name = &quot;dchat&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;
description = &quot;Demo chat to document darkfi net code&quot;

[dependencies]
darkfi = {path = &quot;../../&quot;, features = [&quot;net&quot;, &quot;rpc&quot;]}
</code></pre>
<p>Be sure to replace the path to DarkFi with the correct path for your
setup.</p>
<p>Once that's done we can access DarkFi's net methods inside of
dchat. We'll need a few more external libraries too, so add these
dependencies:</p>
<pre><code># Async
async-std = &quot;1.12.0&quot;
async-trait = &quot;0.1.57&quot;
async-executor = &quot;1.4.1&quot;
async-channel = &quot;1.7.1&quot;
easy-parallel = &quot;3.2.0&quot;
smol = &quot;1.2.5&quot;
num_cpus = &quot;1.13.1&quot;

# Misc
log = &quot;0.4.17&quot;
simplelog = &quot;0.12.0&quot;
url = &quot;2.3.1&quot;

# Encoding and parsing
serde_json = &quot;1.0.85&quot;
serde = {version = &quot;1.0.145&quot;, features = [&quot;derive&quot;]}
toml = &quot;0.5.9&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="writing-a-daemon"><a class="header" href="#writing-a-daemon">Writing a daemon</a></h1>
<p>DarkFi consists of many seperate daemons communicating with each other. To
run the p2p network, we'll need to implement our own daemon.  So we'll
start building <code>dchat</code> by configuring our main function into a daemon that
can run the p2p network.</p>
<pre><pre class="playground"><code class="language-rust">use async_executor::Executor;
use async_std::sync::{Arc, Mutex};
use easy_parallel::Parallel;

use std::{error, fs::File, io::stdin};

use log::debug;
use simplelog::WriteLogger;
use url::Url;

pub type Error = Box&lt;dyn error::Error&gt;;
pub type Result&lt;T&gt; = std::result::Result&lt;T, Error&gt;;

#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    let nthreads = num_cpus::get();
    let (signal, shutdown) = async_channel::unbounded::&lt;()&gt;();

    let (_, result) = Parallel::new()
        .each(0..nthreads, |_| smol::future::block_on(ex2.run(shutdown.recv())))
        .finish(|| {
            smol::future::block_on(async move {
                drop(signal);
                Ok(())
            })
        });

    result
}
</code></pre></pre>
<p>We get the number of cpu cores using <code>num_cpus::get()</code> and spin up a
bunch of threads in parallel using <code>easy_parallel</code>. Right now it doesn't
do anything, but soon we'll run dchat inside this block.</p>
<p><strong>Note</strong>: DarkFi includes a macro called <code>async_daemonize</code> that is used by
DarkFi binaries to minimize boilerplate in the repo.  To keep things
simple we will ignore this macro for the purpose of this tutorial.  But
check it out if you are curious: <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/util/cli.rs#L154">util/cli.rs</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sessions"><a class="header" href="#sessions">Sessions</a></h1>
<p>To deploy the p2p network, we need to configure two types of nodes:
inbound and outbound. These nodes perform different roles on the p2p
network. An inbound node receives connections. An outbound node makes
connections.</p>
<p>The behavior of these nodes is defined in what is called a
<a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/session/mod.rs#L93">Session</a>.
There are four types of sessions: <code>Manual</code>, <code>Inbound</code>, <code>Outbound</code> and <code>SeedSync</code>.</p>
<p>There behavior is as follows: </p>
<p><strong>Inbound</strong>: Uses an <code>Acceptor</code> to accept connections on the inbound connect
address configured in settings.</p>
<p><strong>Outbound</strong>: Starts a connect loop for every connect slot configured in
settings. Establishes a connection using <code>Connector.connect()</code>: a method
that takes an address returns a <code>Channel</code>.</p>
<p><strong>Manual</strong>: Uses a <code>Connector</code> to connect to a single address that is passed
to <code>ManualSession::connect()</code>. Used to create an explicit connection to
a specified address.</p>
<p><strong>SeedSync</strong>: Creates a connection to the seed nodes specified in settings.
Loops through all the configured seeds and tries to connect to them
using a <code>Connector</code>. Either connects successfully, fails with an error or
times out.</p>
<p>To create an inbound and outbound node, we will need to configure them
using a type called <code>net::Settings</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="settings"><a class="header" href="#settings">Settings</a></h1>
<p>On production-ready software, you would usually configure your node
using a config file or command line inputs. On dchat we are keeping
things ultra simple. We pass a command line flag that is either <code>a</code> or
<code>b</code>. If we pass <code>a</code> we will initialize an inbound node. If we pass <code>b</code>
we will initialize an outbound node.</p>
<p>Here's how that works. We define two methods called <code>alice()</code> and
<code>bob()</code>. <code>alice()</code> returns the <code>Settings</code> that will create an inbound
node. bob() return the <code>Settings</code> for an outbound node.</p>
<p>We also implement logging that outputs to <code>/tmp/alice.log</code> and <code>/tmp/bob.log</code>
so we can access the debug output of our nodes. We store this info in a
log file because we don't want it interfering with our terminal UI when
we eventually build it.</p>
<p>This is a function that returns the settings to create Alice, an
inbound node:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn alice() -&gt; Result&lt;Settings&gt; {
   let log_level = simplelog::LevelFilter::Debug;
   let log_config = simplelog::Config::default();

   let log_path = &quot;/tmp/alice.log&quot;;
   let file = File::create(log_path).unwrap();
   WriteLogger::init(log_level, log_config, file)?;

   let seed = Url::parse(&quot;tcp://127.0.0.1:55555&quot;).unwrap();
   let inbound = Url::parse(&quot;tcp://127.0.0.1:55554&quot;).unwrap();
   let ext_addr = Url::parse(&quot;tcp://127.0.0.1:55554&quot;).unwrap();

   let settings = Settings {
       inbound: Some(inbound),
       external_addr: Some(ext_addr),
       seeds: vec![seed],
       ..Default::default()
   };

   Ok(settings)
}
<span class="boring">}
</span></code></pre></pre>
<p>This is a function that returns the settings to create Bob, an
outbound node:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn bob() -&gt; Result&lt;Settings&gt; {
   let log_level = simplelog::LevelFilter::Debug;
   let log_config = simplelog::Config::default();

   let log_path = &quot;/tmp/bob.log&quot;;
   let file = File::create(log_path).unwrap();
   WriteLogger::init(log_level, log_config, file)?;

   let seed = Url::parse(&quot;tcp://127.0.0.1:55555&quot;).unwrap();

   let settings = Settings {
       inbound: None,
       outbound_connections: 5,
       seeds: vec![seed],
       ..Default::default()
   };

   Ok(settings)
}
<span class="boring">}
</span></code></pre></pre>
<p>Both outbound and inbound nodes specify a seed address to connect to. The
inbound node also specifies an external address and an inbound address:
this is where it will receive connections. The outbound node specifies
the number of outbound connection slots, which is the number of outbound
connections the node will try to make.</p>
<p>These are the only settings we need to think about. For the rest, we
use the network defaults.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h1>
<p>Before we continue, we need to quickly add some error handling to handle
the case where a user forgets to add the command-line flag.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::{error, fmt};

#[derive(Debug, Clone)]
pub struct ErrorMissingSpecifier;

impl fmt::Display for ErrorMissingSpecifier {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        write!(f, &quot;missing node specifier. you must specify either a or b&quot;)
    }
}

impl error::Error for ErrorMissingSpecifier {}
<span class="boring">}
</span></code></pre></pre>
<p>Finally we can read the flag from the command-line by adding the following lines to <code>main()</code>:</p>
<pre><pre class="playground"><code class="language-rust">use crate::{
    dchat_error::ErrorMissingSpecifier,
};


#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    let settings: Result&lt;AppSettings&gt; = match std::env::args().nth(1) {
        Some(id) =&gt; match id.as_str() {
            &quot;a&quot; =&gt; alice(),
            &quot;b&quot; =&gt; bob(),
            _ =&gt; Err(ErrorMissingSpecifier.into()),
        },
        None =&gt; Err(ErrorMissingSpecifier.into()),
//...
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="start-run-stop"><a class="header" href="#start-run-stop">Start-Run-Stop</a></h1>
<p>Now that we have initialized the network settings we can create an
instance of the p2p network.</p>
<p>Add the following to <code>main()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let p2p = net::P2p::new(settings.net).await;
<span class="boring">}
</span></code></pre></pre>
<p>We will next create a <code>Dchat</code> struct that will store all the data required
by dchat. For now, it will just hold a pointer to the p2p network.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Dchat {
    p2p: net::P2pPtr,
}

impl Dchat {
    fn new(p2p: net::P2pPtr) -&gt; Self {
        Self { p2p }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Now let's add a <code>start()</code> function to the <code>Dchat</code> implementation. <code>start()</code>
takes an executor and runs three p2p methods, <code>p2p::start()</code>, <code>p2p::run()</code>,
and <code>p2p::stop()</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn start(&amp;mut self, ex: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [START]&quot;);

        self.p2p.clone().start(ex.clone()).await?;

        self.p2p.clone().run(ex.clone()).await?;

        self.p2p.stop().await;

        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [STOP]&quot;);
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<p>Let's take a quick look at the underlying p2p methods we're using here.</p>
<h2 id="start"><a class="header" href="#start">Start</a></h2>
<p>This is <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/p2p.rs#L129">start()</a>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>            &quot;session_outbound&quot;: self.session_outbound().await.get_info().await,
            &quot;state&quot;: self.state.lock().await.to_string(),
        })
    }

    /// Invoke startup and seeding sequence. Call from constructing thread.
    pub async fn start(self: Arc&lt;Self&gt;, executor: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;net&quot;, &quot;P2p::start() [BEGIN]&quot;);

        *self.state.lock().await = P2pState::Start;

        // Start seed session
        let seed = SeedSyncSession::new(Arc::downgrade(&amp;self));
        // This will block until all seed queries have finished
        seed.start(executor.clone()).await?;
<span class="boring">}
</span></code></pre></pre>
<p><code>start()</code> changes the <code>P2pState</code> to <code>P2pState::Start</code> and runs a <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/session/seed_session.rs">seed
session</a>.</p>
<p>This loops through the seed addresses specified in our <code>Settings</code> and
tries to connect to them. The seed session either connects successfully,
fails with an error or times out.</p>
<p>If a seed node connects successfully, it runs a version exchange protocol,
stores the channel in the p2p list of channels, and disconnects, removing
the channel from the channel list.</p>
<h2 id="run"><a class="header" href="#run">Run</a></h2>
<p>This is <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/p2p.rs#L157">run()</a>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    pub async fn session_outbound(&amp;self) -&gt; Arc&lt;OutboundSession&gt; {
        self.session_outbound.lock().await.as_ref().unwrap().clone()
    }

    /// Runs the network. Starts inbound, outbound and manual sessions.
    /// Waits for a stop signal and stops the network if received.
    pub async fn run(self: Arc&lt;Self&gt;, executor: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;net&quot;, &quot;P2p::run() [BEGIN]&quot;);

        *self.state.lock().await = P2pState::Run;

        let manual = self.session_manual().await;
        for peer in &amp;self.settings.peers {
            manual.clone().connect(peer, executor.clone()).await;
        }

        let inbound = self.session_inbound().await;
        inbound.clone().start(executor.clone()).await?;

        let outbound = self.session_outbound().await;
        outbound.clone().start(executor.clone()).await?;

        let stop_sub = self.subscribe_stop().await;
        // Wait for stop signal
        stop_sub.receive().await;

        // Stop the sessions
        manual.stop().await;
<span class="boring">}
</span></code></pre></pre>
<p><code>run()</code> changes the P2pState to <code>P2pState::Run</code>. It then calls <code>start()</code>
on manual, inbound and outbound sessions that are contained with the
<code>P2p</code> struct. The outcome of <code>start()</code> will depend on how your node is
configured. <code>start()</code> will try to run each kind of session, but if the
configuration doesn't match attemping to start a session will simply
return without doing anything. For example, if you are an outbound node,
<code>inbound.start()</code> will return with the following message:</p>
<pre><code>info!(target: &quot;net&quot;, &quot;Not configured for accepting incoming connections.&quot;);
</code></pre>
<p><code>run()</code> then waits for a stop signal and shuts down the sessions when it
is received.</p>
<h2 id="stop"><a class="header" href="#stop">Stop</a></h2>
<p>This is <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/p2p.rs#L186">stop()</a>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>            outbound.stop().await;

        debug!(target: &quot;net&quot;, &quot;P2p::run() [END]&quot;);
<span class="boring">}
</span></code></pre></pre>
<p><code>stop()</code> transmits a shutdown signal to all channels subscribed to the
stop signal and safely shuts down the network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="the-seed-node"><a class="header" href="#the-seed-node">The seed node</a></h1>
<p>Let's create an instance of dchat inside our main function and pass the
p2p network into it.  Then we'll add <code>dchat::start()</code> to our async loop
in the main function. </p>
<pre><pre class="playground"><code class="language-rust">#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    let settings: Result&lt;Settings&gt; = match std::env::args().nth(1) {
        Some(id) =&gt; match id.as_str() {
            &quot;a&quot; =&gt; alice(),
            &quot;b&quot; =&gt; bob(),
            _ =&gt; Err(MissingSpecifier.into()),
        },
        None =&gt; Err(MissingSpecifier.into()),
    };

    let p2p = net::P2p::new(settings?.into()).await;

    let dchat = Dchat::new(p2p);

    let nthreads = num_cpus::get();
    let (signal, shutdown) = async_channel::unbounded::&lt;()&gt;();

    let ex = Arc::new(Executor::new());
    let ex2 = ex.clone();

    let (_, result) = Parallel::new()
        .each(0..nthreads, |_| {
            smol::future::block_on(ex.run(shutdown.recv()))
        })
        .finish(|| {
            smol::future::block_on(async move {
                dchat.start(ex2).await?;
                drop(signal);
                Ok(())
            })
        });

    result
}
</code></pre></pre>
<p>Now try to run the program, don't forget to add a specifier <code>a</code> or <code>b</code>
to define the type of node.</p>
<p>It should output the following error: </p>
<pre><code>Error: NetworkOperationFailed
</code></pre>
<p>That's because there is no seed node online for our nodes to connect to. A
seed node is used when connecting to the network: it is a special kind
of inbound node that gets connected to, sends over a list of addresses
and disconnects again.  This behavior is defined in the <code>ProtocolSeed</code>.</p>
<p>Everytime we run <code>p2p.start()</code> we attempt to connect to a seed using a
<code>SeedSyncSession</code>.  If the <code>SeedSyncSession</code> fails, <code>p2p.start()</code> will fail,
so without a seed node, our inbound and outbound nodes cannot establish
a connection to the network. Let's remedy that.</p>
<p>We have two options here. First, we could implement our own seed node.
Alternatively, DarkFi maintains a master seed node called <code>lilith</code> that
can act as the seed for many different protocols at the same time. For
the purpose of this tutorial let's use <code>lilith</code>.</p>
<p>What <code>lilith</code> does in the background is very simple. Just like any p2p
daemon, a seed node defines its networks settings into a type called
<code>Settings</code> and creates a new instance of the p2p network. It then runs
<code>p2p::start()</code> and <code>p2p::run()</code>. The difference is in the settings: a seed
node just specifies an inbound address which other nodes will connect to.</p>
<p>Crucially, this inbound address must match the seed address we specified
earlier in Alice and Bob's settings.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="deploying-a-local-network"><a class="header" href="#deploying-a-local-network">Deploying a local network</a></h1>
<p>Get ready to spin up a bunch of different terminals. We are going to
run 3 nodes: Alice and Bob and our seed node. To run the seed node,
go to the <code>lilith</code> directory and spawn a new config file by running it once:</p>
<pre><code class="language-bash">cd darkfi
make BINS=lilith
./lilith
</code></pre>
<p>You should see the following output:</p>
<pre><code>Config file created in '&quot;/home/USER/.config/darkfi/lilith_config.toml&quot;'. Please review it and try again.
</code></pre>
<p>Add dchat to the config as follows, keeping in mind that the port number must match the seed we specified
earlier in Alice and Bob's settings.</p>
<pre><code class="language-toml">[network.&quot;dchat&quot;]
port = 50515
</code></pre>
<p>Now run <code>lilith</code>:</p>
<pre><code class="language-bash">./lilith
</code></pre>
<p>Here's what the debug output should look like:</p>
<pre><code>[INFO] Found configuration for network: dchat
[INFO] Starting seed network node for dchat at: tcp://127.0.0.1:50515
[WARN] Skipping seed sync process since no seeds are configured.
[INFO] Starting inbound session on tcp://127.0.0.1:50515
[INFO] Starting 0 outbound connection slots.
</code></pre>
<p>Next we'll head back to <code>dchat</code> and run Alice. </p>
<pre><code class="language-bash">cargo run a
</code></pre>
<p>You can <code>cat</code> or <code>tail</code> the log file created in /tmp/. I recommend using
multitail for colored debug output, like so:</p>
<pre><code class="language-bash">multitail -c /tmp/alice.log
</code></pre>
<p>Check out that debug output! Keep an eye out for this line:</p>
<pre><code>[INFO] Connected seed #0 [tcp://127.0.0.1:55555]
</code></pre>
<p>That shows Alice has connected to the seed node. Here's some more
interesting output:</p>
<pre><code>[DEBUG] (1) net: Attached ProtocolPing
[DEBUG] (1) net: Attached ProtocolSeed
[DEBUG] (1) net: ProtocolVersion::run() [START]
[DEBUG] (1) net: ProtocolVersion::exchange_versions() [START]
</code></pre>
<p>This raises an interesting question- what are these protocols? We'll deal
with that in more detail in a subsequent section. For now it's worth
noting that every node on the p2p network performs several protocols
when it connects to another node.</p>
<p>Keep Alice and the seed node running. Now let's run Bob.</p>
<pre><code class="language-bash">cargo run b
</code></pre>
<p>And track his debug output:</p>
<pre><code class="language-bash">multitail -c /tmp/bob.log
</code></pre>
<p>Success! All going well, Alice and Bob are now connected to each
other. We should be able to watch <code>ping</code> and <code>pong</code> messages being sent
across by tracking their debug output.</p>
<p>We have created a local deployment of the p2p network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="part-2-creating-dchat"><a class="header" href="#part-2-creating-dchat">Part 2: Creating dchat</a></h1>
<p>Now that we've deployed a local version of the p2p network, we can start
creating a custom protocol and message types that dchat will use to
send and receive messages across the network.</p>
<p>This section will cover:</p>
<ul>
<li>The <code>Message</code> type</li>
<li><code>Protocols</code> and the <code>ProtocolRegistry</code></li>
<li>The <code>MessageSubsystem</code></li>
<li><code>MessageSubscription</code></li>
<li><code>Channel</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="creating-a-message-type"><a class="header" href="#creating-a-message-type">Creating a Message type</a></h1>
<p>We'll start by creating a custom <code>Message</code> type called <code>DchatMsg</code>. This is the
data structure that we'll use to send messages between <code>dchat</code> instances.</p>
<p>Messages on the p2p network must implement the <code>Message</code> trait. <code>Message</code> is a
generic type that standardizes all messages on DarkFi's p2p network.</p>
<p>We define a custom type called <code>DchatMsg</code> that implements the
<code>Message</code> trait. We also add <code>darkfi::util::SerialEncodable</code> and
<code>darkfi::util::SerialDecodable</code> macros to our struct definition so our
messages can be parsed by the network.</p>
<p><code>Message</code> requires that we implement a method called <code>name()</code>, which
returns a str of the struct's name.</p>
<p>For the purposes of our chat program, we will also define a buffer where
we can write messages upon receiving them on the p2p network. We'll wrap
this in a <code>Mutex</code> to ensure thread safety and an <code>Arc</code> pointer so we can
pass it around.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use async_std::sync::{Arc, Mutex};

use darkfi::{
    net,
    serial::{SerialDecodable, SerialEncodable},
};

pub type DchatMsgsBuffer = Arc&lt;Mutex&lt;Vec&lt;DchatMsg&gt;&gt;&gt;;

impl net::Message for DchatMsg {
    fn name() -&gt; &amp;'static str {
        &quot;DchatMsg&quot;
    }
}

#[derive(Debug, Clone, SerialEncodable, SerialDecodable)]
pub struct DchatMsg {
    pub msg: String,
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="understanding-protocols"><a class="header" href="#understanding-protocols">Understanding protocols</a></h1>
<p>We now need to implement a custom protocol which defines how our chat
program interacts with the p2p network.</p>
<p>We've already interacted with several protocols already. Protocols
are automatically activated when nodes connect to eachother on the
p2p network. Here are examples of two protocols that every node runs
continuously in the background:</p>
<ul>
<li><a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/protocol/protocol_ping.rs">ProtocolPing</a>:
sends <code>ping</code>, receives <code>pong</code></li>
<li><a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/protocol/protocol_address.rs">ProtocolAddress</a>:
receives a <code>get_address</code> message, sends an <code>address</code> message</li>
</ul>
<p>Under the hood, these protocols have a few similarities:</p>
<ul>
<li>They create a subscription to a message type, such as <code>ping</code> and <code>pong</code>.</li>
<li>They implement <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/protocol/protocol_base.rs">ProtocolBase</a>,
DarkFi's generic protocol trait.</li>
<li>They run asynchronously using the
<a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/protocol/protocol_jobs_manager.rs">ProtocolJobsManager</a>.</li>
<li>They hold a pointer to <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/channel.rs">Channel</a> which
invokes the <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/net/message_subscriber.rs#L170">MessageSubsystem</a>.</li>
</ul>
<p>This introduces several generic interfaces that we must use to build
our custom protocol. In particular:</p>
<p><strong>The Message Subsystem</strong></p>
<p><code>MessageSubsystem</code> is a generic publish/subscribe class that contains
a list of <code>Message</code> dispatchers. A new dispatcher is created for every
<code>Message</code> type. These <code>Message</code> specific dispatchers maintain a list of
susbscribers that are subscribed to a particular <code>Message</code>.</p>
<p><strong>Message Subscription</strong></p>
<p>A subscription to a specific <code>Message</code> type. Handles receiving messages
on a subscription.</p>
<p><strong>Channel</strong></p>
<p><code>Channel</code> is an async connection for communication between nodes. It is
also a powerful interface that exposes methods to the <code>MessageSubsystem</code>
and implements <code>MessageSubscription</code>.</p>
<p><strong>The Protocol Registry</strong></p>
<p><code>ProtocolRegistry</code> is a registry of all protocols. We use it through the
method <code>register()</code> which passes a protocol constructor and a session
<code>bitflag</code>. The <code>bitflag</code> specifies which sessions the protocol is created
for. The <code>ProtocolRegistry</code> then spawns new protocols for different channels
depending on the session.</p>
<p><strong>ProtocolJobsManager</strong></p>
<p>An asynchronous job manager that spawns and stops tasks. Its main
purpose is so a protocol can cleanly close all started jobs, through
the function <code>close_all_tasks()</code>.  This way if the connection between
nodes is dropped and the channel closes, all protocols are also shutdown.</p>
<p><strong>ProtocolBase</strong></p>
<p>A generic protocol trait that all protocols must implement.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="protocoldchat"><a class="header" href="#protocoldchat">ProtocolDchat</a></h1>
<p>Let's start tying these concepts together. We'll define a struct called
<code>ProtocolDchat</code> that contains a <code>MessageSubscription</code> to <code>DchatMsg</code> and a
pointer to the <code>ProtocolJobsManager</code>. We'll also include the <code>DchatMsgsBuffer</code>
in the struct as it will come in handy later on.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use async_executor::Executor;
use async_std::sync::Arc;
use async_trait::async_trait;
use darkfi::{net, Result};
use log::debug;

use crate::dchatmsg::{DchatMsg, DchatMsgsBuffer};

pub struct ProtocolDchat {
    jobsman: net::ProtocolJobsManagerPtr,
    msg_sub: net::MessageSubscription&lt;DchatMsg&gt;,
    msgs: DchatMsgsBuffer,
}
<span class="boring">}
</span></code></pre></pre>
<p>Next we'll implement the trait <code>ProtocolBase</code>. <code>ProtocolBase</code> requires
two functions, <code>start()</code> and <code>name()</code>. In <code>start()</code> we will start up the
<code>ProtocolJobsManager</code>. <code>name()</code> will return a <code>str</code> of the protocol name.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl net::ProtocolBase for ProtocolDchat {
    async fn start(self: Arc&lt;Self&gt;, executor: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;ProtocolDchat::ProtocolBase::start() [START]&quot;);
        self.jobsman.clone().start(executor.clone());
        debug!(target: &quot;dchat&quot;, &quot;ProtocolDchat::ProtocolBase::start() [STOP]&quot;);
        Ok(())
    }

    fn name(&amp;self) -&gt; &amp;'static str {
        &quot;ProtocolDchat&quot;
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Once that's done, we'll need to create a <code>ProtocolDchat</code> constructor
that we will pass to the <code>ProtocolRegistry</code> to register our protocol.
We'll invoke the <code>MessageSubsystem</code> and add <code>DchatMsg</code> as to the list
of dispatchers. Next, we'll create a <code>MessageSubscription</code> to <code>DchatMsg</code>
using the method <code>subscribe_msg()</code>.</p>
<p>We'll also initialize the <code>ProtocolJobsManager</code> and finally return a
pointer to the protocol.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl ProtocolDchat {
    pub async fn init(channel: net::ChannelPtr, msgs: DchatMsgsBuffer) -&gt; net::ProtocolBasePtr {
        debug!(target: &quot;dchat&quot;, &quot;ProtocolDchat::init() [START]&quot;);
        let message_subsytem = channel.get_message_subsystem();
        message_subsytem.add_dispatch::&lt;DchatMsg&gt;().await;

        let msg_sub =
            channel.subscribe_msg::&lt;DchatMsg&gt;().await.expect(&quot;Missing DchatMsg dispatcher!&quot;);

        Arc::new(Self {
            jobsman: net::ProtocolJobsManager::new(&quot;ProtocolDchat&quot;, channel.clone()),
            msg_sub,
            msgs,
        })
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>We're nearly there. But right now the protocol doesn't actually do
anything. Let's write a method called <code>handle_receive_msg()</code> which receives
a message on our <code>MessageSubscription</code> and adds it to <code>DchatMsgsBuffer</code>.</p>
<p>Put this inside the <code>ProtocolDchat</code> implementation:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn handle_receive_msg(self: Arc&lt;Self&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;ProtocolDchat::handle_receive_msg() [START]&quot;);
        while let Ok(msg) = self.msg_sub.receive().await {
            let msg = (*msg).to_owned();
            self.msgs.lock().await.push(msg);
        }

        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<p>As a final step, let's add that task to the <code>ProtocolJobManager</code> that is invoked
in <code>start()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn start(self: Arc&lt;Self&gt;, executor: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        //...
        self.jobsman.clone().spawn(self.clone().handle_receive_msg(), executor.clone()).await;
        //...
    }
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="registering-a-protocol"><a class="header" href="#registering-a-protocol">Registering a protocol</a></h1>
<p>We've now successfully created a custom protocol. The next step is the
register the protocol with the <code>ProtocolRegistry</code>.</p>
<p>We'll define a new function inside the <code>Dchat</code> implementation called
<code>register_protocol()</code>. It will invoke the <code>ProtocolRegistry</code> using the
handle to the p2p network contained in the <code>Dchat</code> struct. It will then
call <code>register()</code> on the registry and pass the <code>ProtocolDchat</code> constructor.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn register_protocol(&amp;self, msgs: DchatMsgsBuffer) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;Dchat::register_protocol() [START]&quot;);
        let registry = self.p2p.protocol_registry();
        registry
            .register(!net::SESSION_SEED, move |channel, _p2p| {
                let msgs2 = msgs.clone();
                async move { ProtocolDchat::init(channel, msgs2).await }
            })
            .await;
        debug!(target: &quot;dchat&quot;, &quot;Dchat::register_protocol() [STOP]&quot;);
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<p>There's a lot going on here. <code>register()</code> takes a closure with two
arguments, <code>channel</code> and <code>p2p</code>. We use <code>move</code> to capture these values. We
then create an async closure that captures these values and the value
<code>msgs</code> and use them to call <code>ProtocolDchat::init()</code> in the async block.</p>
<p>The code would be expressed more simply as:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>registry.register(!net::SESSION_SEED, async move |channel, _p2p| {
        ProtocolDchat::init(channel, msgs).await
    })
    .await;
<span class="boring">}
</span></code></pre></pre>
<p>However we cannot do this due to limitation with async closures. So
instead we wrap the <code>async move</code> in a <code>move</code> in order to capture the
variables needed by <code>ProtocolDchat::init()</code>.</p>
<p>Notice the use of a <code>bitflag</code>. We use <code>!SESSION_SEED</code> to specify that
this protocol should be performed by all sessions aside from the
seed session.</p>
<p>Also notice that <code>register_protocol()</code> requires a <code>DchatMsgsBuffer</code> that we
send to the <code>ProtocolDchat</code> constructor. We'll create the <code>DchatMsgsBuffer</code>
in <code>main()</code> and pass it to <code>Dchat::new()</code>. Let's add <code>DchatMsgsBuffer</code> to the
<code>Dchat</code> struct definition first.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use crate::{
    dchat_error::ErrorMissingSpecifier,
    dchatmsg::{DchatMsg, DchatMsgsBuffer},
    protocol_dchat::ProtocolDchat,
};

struct Dchat {
    p2p: net::P2pPtr,
    recv_msgs: DchatMsgsBuffer,
}

impl Dchat {
    fn new(p2p: net::P2pPtr, recv_msgs: DchatMsgsBuffer) -&gt; Self {
        Self { p2p, recv_msgs }
    }
    //...
}
<span class="boring">}
</span></code></pre></pre>
<p>And initialize it:</p>
<pre><pre class="playground"><code class="language-rust">#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    //...
    let msgs: DchatMsgsBuffer = Arc::new(Mutex::new(vec![DchatMsg { msg: String::new() }]));

    let mut dchat = Dchat::new(p2p, msgs);
    //...
}
</code></pre></pre>
<p>Finally, call <code>register_protocol()</code> in <code>dchat::start()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn start(&amp;mut self, ex: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [START]&quot;);

        let ex2 = ex.clone();

        self.register_protocol(self.recv_msgs.clone()).await?;
        self.p2p.clone().start(ex.clone()).await?;
        self.p2p.clone().run(ex.clone()).await?;

        self.p2p.stop().await;

        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [STOP]&quot;);
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<p>Now try running Alice and Bob and seeing what debug output you get. Keep
an eye out for the following:</p>
<pre><code>[DEBUG] (1) net: Channel::subscribe_msg() [START, command=&quot;DchatMsg&quot;, address=tcp://127.0.0.1:55555]
[DEBUG] (1) net: Channel::subscribe_msg() [END, command=&quot;DchatMsg&quot;, address=tcp://127.0.0.1:55555]
[DEBUG] (1) net: Attached ProtocolDchat
</code></pre>
<p>If you see that, we have successfully:</p>
<ul>
<li>Implemented a custom <code>Message</code> and created a <code>MessageSubscription</code>.</li>
<li>Implemented a custom <code>Protocol</code> and registered it with the <code>ProtocolRegistry</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sending-messages"><a class="header" href="#sending-messages">Sending messages</a></h1>
<p>The core of our application has been built. All that's left is to add a UI
that takes user input, creates a <code>DchatMsg</code> and sends it over the network.</p>
<p>Let's start by creating a <code>send()</code> function inside <code>Dchat</code>. This will
introduce us to a new p2p method that is essential to our chat app:
<code>p2p.broadcast()</code>.</p>
<pre><code>    async fn send(&amp;self, msg: String) -&gt; Result&lt;()&gt; {
        let dchatmsg = DchatMsg { msg };
        self.p2p.broadcast(dchatmsg).await?;
        Ok(())
    }
</code></pre>
<p>We pass a <code>String</code> called msg that will be taken from user input. We use
this input to initialize a message of the type <code>DchatMsg</code> that the network
can now support. Finally, we pass the message into <code>p2p.broadcast()</code>.</p>
<p>Here's what happens under the hood:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>    /// Wait for outbound connections to be established.
    pub async fn wait_for_outbound(self: Arc&lt;Self&gt;, executor: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;net&quot;, &quot;P2p::wait_for_outbound() [BEGIN]&quot;);
        // To verify that the network needs initialization, we check if we have seeds or peers configured,
        // and have configured outbound slots.
<span class="boring">}
</span></code></pre></pre>
<p>This is pretty straightforward: <code>broadcast()</code> takes a generic <code>Message</code> type
and sends it across all the channels that our node has access to.</p>
<p>All that's left to do is to create a UI.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="slap-on-a-ui"><a class="header" href="#slap-on-a-ui">Slap on a UI</a></h1>
<p>We'll create a new method called <code>menu()</code> inside the <code>Dchat</code>
implementation. It implements a highly simple UI that allows a user to
send messages and see received messages inside the inbox. Our inbox
simply displays the messages that <code>ProtocolDchat</code> has saved in the
<code>DchatMsgBuffer</code>.</p>
<p>Here's what is should look like:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn menu(&amp;self) -&gt; Result&lt;()&gt; {
        let mut buffer = String::new();
        let stdin = stdin();
        loop {
            println!(
                &quot;Welcome to dchat.
    s: send message
    i: inbox
    q: quit &quot;
            );
            stdin.read_line(&amp;mut buffer)?;
            // Remove trailing \n
            buffer.pop();
            match buffer.as_str() {
                &quot;q&quot; =&gt; return Ok(()),
                &quot;s&quot; =&gt; {
                    // Remove trailing s
                    buffer.pop();
                    stdin.read_line(&amp;mut buffer)?;
                    match self.send(buffer.clone()).await {
                        Ok(_) =&gt; {
                            println!(&quot;you sent: {}&quot;, buffer);
                        }
                        Err(e) =&gt; {
                            println!(&quot;send failed for reason: {}&quot;, e);
                        }
                    }
                    buffer.clear();
                }
                &quot;i&quot; =&gt; {
                    let msgs = self.recv_msgs.lock().await;
                    if msgs.is_empty() {
                        println!(&quot;inbox is empty&quot;)
                    } else {
                        println!(&quot;received:&quot;);
                        for i in msgs.iter() {
                            if !i.msg.is_empty() {
                                println!(&quot;{}&quot;, i.msg);
                            }
                        }
                    }
                    buffer.clear();
                }
                _ =&gt; {}
            }
        }
    }
<span class="boring">}
</span></code></pre></pre>
<p>We'll call <code>menu()</code> inside of <code>dchat::start()</code> along with our other methods, like so:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn start(&amp;mut self, ex: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [START]&quot;);

        self.register_protocol(self.recv_msgs.clone()).await?;
        self.p2p.clone().start(ex.clone()).await?;
        self.p2p.clone().run(ex.clone()).await?;

        self.menu().await?;

        self.p2p.stop().await;

        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [STOP]&quot;);
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<p>But wait- if you try running this code, you'll notice that the menu never
gets displayed. That's because we call <code>.await</code> on the previous function
call, <code>p2p.run()</code>. <code>p2p.run()</code> is a loop that runs until we exit the program,
so in order for it to not block other threads from executing we'll need
to detach it in the background.</p>
<p>The complete implementaion looks like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn start(&amp;mut self, ex: Arc&lt;Executor&lt;'_&gt;&gt;) -&gt; Result&lt;()&gt; {
        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [START]&quot;);

        let ex2 = ex.clone();

        self.register_protocol(self.recv_msgs.clone()).await?;
        self.p2p.clone().start(ex.clone()).await?;
        ex2.spawn(self.p2p.clone().run(ex.clone())).detach();

        self.menu().await?;

        self.p2p.stop().await;

        debug!(target: &quot;dchat&quot;, &quot;Dchat::start() [STOP]&quot;);
        Ok(())
    }
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="using-dchat"><a class="header" href="#using-dchat">Using dchat</a></h1>
<p>We are finally ready to test our program. Spin up 5 different terminals.</p>
<p>In terminal 1, run <code>lilith</code>.</p>
<pre><code>./lilith
</code></pre>
<p>In terminal 2, run Alice.</p>
<pre><code>cargo run a 
</code></pre>
<p>In terminal 3, run Bob.</p>
<pre><code>cargo run b
</code></pre>
<p>In terminal 4, display Alice's debug output.</p>
<pre><code>multitail -c /tmp/alice.log
</code></pre>
<p>In terminal 5, display Bob's debug output.</p>
<pre><code>multitail -c /tmp/bob.log
</code></pre>
<p>Now use the UI to send messages between Alice and Bob. We have
successfully implemented a p2p chat program.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="network-tools"><a class="header" href="#network-tools">Network tools</a></h1>
<p>In its current state, dchat is ready to use. But there's steps we can
take to improve it. If we connect dchat to JSON-RPC, we gain access to
a tool called <code>dnetview</code> that allows us to visually explore connections
and messages on the p2p network.</p>
<p>As well as facilitating debugging, connecting
<code>dnetview</code> is a good excuse to dive into DarkFi's <a href="https://github.com/darkrenaissance/darkfi/tree/master/src/rpc">rpc
module</a>
which is essential to the DarkFi code base.</p>
<p>This section will cover:</p>
<ul>
<li>DarkFi's JSON-RPC interface</li>
<li>Exploring the p2p network topology using <code>dnetview</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rpc-interface"><a class="header" href="#rpc-interface">RPC interface</a></h1>
<p>Let's begin connecting dchat up to JSON-RPC using DarkFi's <a href="https://github.com/darkrenaissance/darkfi/tree/master/src/rpc">rpc
module</a>.</p>
<p>We'll start by defining a new struct called <code>JsonRpcInterface</code> that
takes two values, an accept <code>Url</code> that will receive JSON-RPC requests,
and a pointer to the p2p network.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use async_trait::async_trait;
use log::debug;
use serde_json::{json, Value};
use url::Url;

use darkfi::{
    net,
    rpc::{
        jsonrpc::{ErrorCode, JsonError, JsonRequest, JsonResponse, JsonResult},
        server::RequestHandler,
    },
};

pub struct JsonRpcInterface {
    pub addr: Url,
    pub p2p: net::P2pPtr,
}
<span class="boring">}
</span></code></pre></pre>
<p>We'll need to implement a trait called <code>RequestHandler</code> for
the <code>JsonRpcInterface</code>. <code>RequestHandler</code> exposes a method called
<code>handle_request()</code> which is a handle for processing incoming
JSON-RPC requests. <code>handle_request()</code> takes a <code>JsonRequest</code>
and returns a <code>JsonResult</code>. These types are defined inside
<a href="https://github.com/darkrenaissance/darkfi/blob/master/src/rpc/jsonrpc.rs">jsonrpc.rs</a></p>
<p>This is <code>JsonResult</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Clone, Debug, Serialize, Deserialize)]
#[serde(untagged)]
pub enum JsonResult {
    Response(JsonResponse),
    Error(JsonError),
    Notification(JsonNotification),
}
<span class="boring">}
</span></code></pre></pre>
<p>This is <code>JsonRequest</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A JSON-RPC request object.
#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct JsonRequest {
    /// JSON-RPC version
    pub jsonrpc: Value,
    /// Request ID
    pub id: Value,
    /// Request method
    pub method: Value,
    /// Request parameters
    pub params: Value,
}
<span class="boring">}
</span></code></pre></pre>
<p>We'll use <code>handle_request()</code> to run a match statement on
<code>JsonRequest.method</code>.</p>
<p>Running a match on <code>method</code> will allow us to branch out to functions
that respond to methods received over JSON-RPC.  We haven't implemented
any methods yet, so for now let's just return a <code>JsonError</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl RequestHandler for JsonRpcInterface {
    async fn handle_request(&amp;self, req: JsonRequest) -&gt; JsonResult {
        if req.params.as_array().is_none() {
            return JsonError::new(ErrorCode::InvalidRequest, None, req.id).into()
        }

        debug!(target: &quot;RPC&quot;, &quot;--&gt; {}&quot;, serde_json::to_string(&amp;req).unwrap());

        match req.method.as_str() {
            Some(_) | None =&gt; JsonError::new(ErrorCode::MethodNotFound, None, req.id).into(),
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="accept-addr"><a class="header" href="#accept-addr">Accept addr</a></h1>
<p>To deploy the <code>JsonRpcInterface</code> and start receiving JSON-RPC requests,
we'll need to configure a JSON-RPC accept address.</p>
<p>Let's return to our functions <code>alice()</code> and <code>bob()</code>. To enable Alice and
Bob to connect to JSON-RPC, we'll need to generalize this return a RPC
<code>Url</code> as well as a <code>Settings</code>.</p>
<p>Let's define a new struct called <code>AppSettings</code> that has two fields,
<code>Url</code> and <code>Settings</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Clone, Debug)]
struct AppSettings {
    accept_addr: Url,
    net: Settings,
}

impl AppSettings {
    pub fn new(accept_addr: Url, net: Settings) -&gt; Self {
        Self { accept_addr, net }
    }
<span class="boring">}
</span></code></pre></pre>
<p>Next, we'll change our <code>alice()</code> method to return a <code>AppSettings</code>
instead of a <code>Settings</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn alice() -&gt; Result&lt;AppSettings&gt; {
    //...
    let seed = Url::parse(&quot;tcp://127.0.0.1:50515&quot;).unwrap();
    let inbound = Url::parse(&quot;tcp://127.0.0.1:51554&quot;).unwrap();
    let ext_addr = Url::parse(&quot;tcp://127.0.0.1:51554&quot;).unwrap();

    let net = Settings {
        inbound: vec![inbound],
        external_addr: vec![ext_addr],
        seeds: vec![seed],
        ..Default::default()
    };

    let accept_addr = Url::parse(&quot;tcp://127.0.0.1:55054&quot;).unwrap();
    let settings = AppSettings::new(accept_addr, net);

    Ok(settings)
}
<span class="boring">}
</span></code></pre></pre>
<p>And the same for <code>bob()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn bob() -&gt; Result&lt;AppSettings&gt; {
    //...
    let net = Settings {
        inbound: vec![],
        outbound_connections: 5,
        seeds: vec![seed],
        ..Default::default()
    };

    let accept_addr = Url::parse(&quot;tcp://127.0.0.1:51054&quot;).unwrap();
    let settings = AppSettings::new(accept_addr, net);

    Ok(settings)
}
<span class="boring">}
</span></code></pre></pre>
<p>Update <code>main()</code> with the new type:</p>
<pre><pre class="playground"><code class="language-rust">#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    let settings: Result&lt;AppSettings&gt; = match std::env::args().nth(1) {
        Some(id) =&gt; match id.as_str() {
            &quot;a&quot; =&gt; alice(),
            &quot;b&quot; =&gt; bob(),
            _ =&gt; Err(ErrorMissingSpecifier.into()),
        },
        None =&gt; Err(ErrorMissingSpecifier.into()),
    };

    let settings = settings?.clone();

    let p2p = net::P2p::new(settings.net).await;
    //...
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="methods"><a class="header" href="#methods">Methods</a></h1>
<p>We're ready to deploy our <code>JsonRpcInterface</code>. But right now now it just
returns <code>JsonError::MethodNotFound</code>. So before testing out the JSON-RPC,
let's implement some methods.</p>
<p>We'll start with a simple <code>pong</code> method that replies to <code>ping</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl JsonRpcInterface {
    // RPCAPI:
    // Replies to a ping method.
    // --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;ping&quot;, &quot;params&quot;: [], &quot;id&quot;: 42}
    // &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;pong&quot;, &quot;id&quot;: 42}
    async fn pong(&amp;self, id: Value, _params: Value) -&gt; JsonResult {
        JsonResponse::new(json!(&quot;pong&quot;), id).into()
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>And add it to <code>handle_request()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl RequestHandler for JsonRpcInterface {
    async fn handle_request(&amp;self, req: JsonRequest) -&gt; JsonResult {
        //...
        match req.method.as_str() {
            Some(&quot;ping&quot;) =&gt; self.pong(req.id, req.params).await,
            Some(_) | None =&gt; JsonError::new(ErrorCode::MethodNotFound, None, req.id).into(),
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="rpc-server"><a class="header" href="#rpc-server">RPC server</a></h1>
<p>To deploy the <code>JsonRpcInterface</code>, we'll need to
create an RPC server using <code>listen_and_serve()</code>.
<code>listen_and_serve()</code> is a method defined in DarkFi's <a href="https://github.com/darkrenaissance/darkfi/tree/master/src/rpc/server.rs">rpc
module</a>.
It starts a JSON-RPC server that is bound to the provided accept URL
and uses our previously implemented <code>RequestHandler</code> to handle incoming
requests.</p>
<p>Add the following lines to <code>main()</code>:</p>
<pre><pre class="playground"><code class="language-rust">#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {

    //...
    let accept_addr = settings.accept_addr.clone();
    let rpc = Arc::new(JsonRpcInterface { addr: accept_addr.clone(), p2p });
    ex.spawn(async move { listen_and_serve(accept_addr.clone(), rpc).await }).detach();

    //...
}
</code></pre></pre>
<p>We create a new <code>JsonRpcInterface</code> inside an <code>Arc</code> pointer and pass in our
<code>accept_addr</code> and <code>p2p</code> object.</p>
<p>Next, we create an async block that calls <code>listen_and_serve()</code>. The async
block uses the <code>move</code> keyword to takes ownership of the <code>accept_addr</code>
and <code>JsonRpcInterface</code> values and pass them into <code>listen_and_serve()</code>.
We use an <code>executor</code> to spawn <code>listen_and_serve()</code> as a new thread and
detach it in the background.</p>
<p>We have enabled JSON-RPC.</p>
<p>Here's what our complete <code>main()</code> function looks like:</p>
<pre><pre class="playground"><code class="language-rust">#[async_std::main]
async fn main() -&gt; Result&lt;()&gt; {
    let settings: Result&lt;AppSettings&gt; = match std::env::args().nth(1) {
        Some(id) =&gt; match id.as_str() {
            &quot;a&quot; =&gt; alice(),
            &quot;b&quot; =&gt; bob(),
            _ =&gt; Err(ErrorMissingSpecifier.into()),
        },
        None =&gt; Err(ErrorMissingSpecifier.into()),
    };

    let settings = settings?.clone();

    let p2p = net::P2p::new(settings.net).await;

    let nthreads = num_cpus::get();
    let (signal, shutdown) = async_channel::unbounded::&lt;()&gt;();

    let ex = Arc::new(Executor::new());
    let ex2 = ex.clone();
    let ex3 = ex2.clone();

    let msgs: DchatMsgsBuffer = Arc::new(Mutex::new(vec![DchatMsg { msg: String::new() }]));

    let mut dchat = Dchat::new(p2p.clone(), msgs);

    let accept_addr = settings.accept_addr.clone();
    let rpc = Arc::new(JsonRpcInterface { addr: accept_addr.clone(), p2p });
    ex.spawn(async move { listen_and_serve(accept_addr.clone(), rpc).await }).detach();

    let (_, result) = Parallel::new()
        .each(0..nthreads, |_| smol::future::block_on(ex2.run(shutdown.recv())))
        .finish(|| {
            smol::future::block_on(async move {
                dchat.start(ex3).await?;
                drop(signal);
                Ok(())
            })
        });

    result
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="get_info"><a class="header" href="#get_info">get_info</a></h1>
<p>If you run Alice now, you'll see the following output:</p>
<pre><code>[DEBUG] jsonrpc-server: Trying to bind listener on tcp://127.0.0.1:55054
</code></pre>
<p>That indicates that our JSON-RPC server is up and running. However,
there's currently no client for us to connect to. That's where <code>dnetview</code>
comes in. <code>dnetview</code> implements a JSON-RPC client that calls a single
method: <code>get_info()</code>.</p>
<p>To use it, let's return to our <code>JsonRpcInterface</code> and add the following
method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    // RPCAPI:
    // Retrieves P2P network information.
    // --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_info&quot;, &quot;params&quot;: [], &quot;id&quot;: 42}
    // &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, result&quot;: {&quot;nodeID&quot;: [], &quot;nodeinfo&quot;: [], &quot;id&quot;: 42}
    async fn get_info(&amp;self, id: Value, _params: Value) -&gt; JsonResult {
        let resp = self.p2p.get_info().await;
        JsonResponse::new(resp, id).into()
    }
<span class="boring">}
</span></code></pre></pre>
<p>And add it to <code>handle_request()</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn handle_request(&amp;self, req: JsonRequest) -&gt; JsonResult {
        //...
        match req.method.as_str() {
            Some(&quot;ping&quot;) =&gt; self.pong(req.id, req.params).await,
            Some(&quot;get_info&quot;) =&gt; self.get_info(req.id, req.params).await,
            Some(_) | None =&gt; JsonError::new(ErrorCode::MethodNotFound, None, req.id).into(),
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>This calls the p2p function <code>get_info()</code> and passes the returned data into a
<code>JsonResponse</code>.</p>
<p>Under the hood, this function triggers a hierarchy of <code>get_info()</code>
calls which deliver info specific to a node, its inbound or outbound
<code>Session</code>'s, and the <code>Channel</code>'s those <code>Session</code>'s run.</p>
<p>Here's what happens:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        *self_.session_outbound.lock().await = Some(OutboundSession::new(parent));

        register_default_protocols(self_.clone()).await;

        self_
    }

    pub async fn get_info(&amp;self) -&gt; serde_json::Value {
        // Building ext_addr_vec string
        let mut ext_addr_vec = vec![];
        for ext_addr in &amp;self.settings.external_addr {
            ext_addr_vec.push(ext_addr.as_ref().to_string());
        }

        json!({
            &quot;external_addr&quot;: format!(&quot;{:?}&quot;, ext_addr_vec),
<span class="boring">}
</span></code></pre></pre>
<p>Here we return two pieces of info that are unique to a node:
<code>external_addr</code> and <code>state</code>. We couple that data with <code>SessionInfo</code>
by calling <code>get_info()</code> on each <code>Session</code>.</p>
<p><code>Session::get_info()</code> returns data related to a <code>Session</code>
(for example, an Inbound <code>accept_addr</code> in the case of an
inbound <code>Session</code>). <code>Session::get_info()</code> then calls the function
<code>Channel::get_info()</code> which returns data specific to a <code>Channel</code>. This
happens via a child struct called <code>ChannelInfo</code>.</p>
<p>This is <code>ChannelInfo::get_info()</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>            last_status: String::new(),
            log,
        }
    }

    async fn get_info(&amp;self) -&gt; serde_json::Value {
        let log = match &amp;self.log {
            Some(l) =&gt; {
                let mut lock = l.lock().await;
                let ret = lock.clone();
                *lock = Vec::new();
<span class="boring">}
</span></code></pre></pre>
<p><code>dnetview</code> uses the info returned from <code>Channel</code> and <code>Session</code> and
node-specific info like <code>external_addr</code> to display an overview of the
p2p network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="using-dnetview"><a class="header" href="#using-dnetview">Using dnetview</a></h1>
<p>Finally, we're ready to use <code>dnetview</code>. Go to the <code>dnetview</code> directory
and spawn a new config file by running it once:</p>
<pre><code class="language-bash">cd darkfi
make BINS=dnetview
./dnetview
</code></pre>
<p>You should see the following output:</p>
<pre><code>Config file created in '&quot;/home/USER/.config/darkfi/dnetview_config.toml&quot;'. Please review it and try again.
</code></pre>
<p>Edit the config file to include the JSON-RPC accept addresses for Alice
and Bob:</p>
<pre><code class="language-toml">[[nodes]]
name = &quot;alice&quot;
rpc_url=&quot;tcp://127.0.0.1:55054&quot;

[[nodes]]
name = &quot;bob&quot;
rpc_url=&quot;tcp://127.0.0.1:51054&quot;
</code></pre>
<p>Now run <code>dnetview</code>:</p>
<pre><code class="language-bash">./dnetview
</code></pre>
<p>This is what you should see:</p>
<p><img src="learn/dchat/network-tools/images/dnetview-offline.jpg" alt="" /></p>
<p>We haven't ran Alice and Bob yet, so <code>dnetview</code> can't connect to them. So
let's run Alice and Bob.</p>
<pre><code class="language-bash">cargo run a
</code></pre>
<pre><code class="language-bash">cargo run b
</code></pre>
<p>Now try running <code>dnetview</code> again.</p>
<p><img src="learn/dchat/network-tools/images/dnetview-online.jpg" alt="" /></p>
<p>That's fun. Use <code>j</code> and <code>k</code> to navigate. See what happens when you select
a <code>Channel</code>.</p>
<p><img src="learn/dchat/network-tools/images/dnetview-msgs.jpg" alt="" /></p>
<p>On each <code>Channel</code>, we see a log of messages being sent across the network.
What happens when we send a message?</p>
<p><img src="learn/dchat/network-tools/images/dnetview-dchatmsg.jpg" alt="" /></p>
<p>This is Bob receiving a DchatMsg message on the <code>Channel</code>
<code>tcp://127.0.0.1:51554</code>. Pretty cool.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="debugging"><a class="header" href="#debugging">Debugging</a></h1>
<p>As a final step, let's quickly turn to the debug output of <code>dnetview</code>
which is stored in <code>/tmp/dnetview.log</code>.</p>
<p>Run <code>dnetview</code> in <code>verbose</code> mode to enable debugging.</p>
<pre><code class="language-bash">./dnetview -v
</code></pre>
<p>Here's an example output. This is Alice:</p>
<pre><code class="language-json">[DEBUG] (16) jsonrpc-client: &lt;-- {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:8105306807249776489,&quot;result&quot;:{&quot;external_addr&quot;:&quot;tcp://127.0.0.1:51554&quot;,&quot;session_inbound&quot;:{&quot;connected&quot;:{&quot;tcp://127.0.0.1:36428&quot;:[{&quot;accept_addr&quot;:&quot;tcp://127.0.0.1:51554&quot;},{&quot;last_msg&quot;:&quot;addr&quot;,&quot;last_status&quot;:&quot;recv&quot;,&quot;log&quot;:[[1659950874808537094,&quot;send&quot;,&quot;version&quot;],[1659950874810919251,&quot;recv&quot;,&quot;version&quot;],[1659950874811104471,&quot;send&quot;,&quot;verack&quot;],[1659950874811491950,&quot;recv&quot;,&quot;verack&quot;],[1659950874812397628,&quot;send&quot;,&quot;getaddr&quot;],[1659950874814847748,&quot;recv&quot;,&quot;getaddr&quot;],[1659950874815100189,&quot;send&quot;,&quot;addr&quot;],[1659950874816306644,&quot;recv&quot;,&quot;addr&quot;]],&quot;random_id&quot;:2658393884,&quot;remote_node_id&quot;:&quot;&quot;}]}},&quot;session_manual&quot;:{&quot;key&quot;:110},&quot;session_outbound&quot;:{&quot;slots&quot;:[]},&quot;state&quot;:&quot;run&quot;}}
</code></pre>
<p>This is Bob: </p>
<pre><code class="language-json">[DEBUG] (16) jsonrpc-client: &lt;-- {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:17000304364801751931,&quot;result&quot;:{&quot;external_addr&quot;:null,&quot;session_inbound&quot;:{&quot;connected&quot;:{}},&quot;session_manual&quot;:{&quot;key&quot;:110},&quot;session_outbound&quot;:{&quot;slots&quot;:[{&quot;addr&quot;:null,&quot;channel&quot;:null,&quot;state&quot;:&quot;open&quot;},{&quot;addr&quot;:null,&quot;channel&quot;:null,&quot;state&quot;:&quot;open&quot;},{&quot;addr&quot;:&quot;tcp://127.0.0.1:51554&quot;,&quot;channel&quot;:{&quot;last_msg&quot;:&quot;addr&quot;,&quot;last_status&quot;:&quot;sent&quot;,&quot;log&quot;:[],&quot;random_id&quot;:3924275147,&quot;remote_node_id&quot;:&quot;&quot;},&quot;state&quot;:&quot;connected&quot;},{&quot;addr&quot;:null,&quot;channel&quot;:null,&quot;state&quot;:&quot;open&quot;},{&quot;addr&quot;:&quot;tcp://127.0.0.1:50515&quot;,&quot;channel&quot;:{&quot;last_msg&quot;:&quot;addr&quot;,&quot;last_status&quot;:&quot;sent&quot;,&quot;log&quot;:[],&quot;random_id&quot;:2182348290,&quot;remote_node_id&quot;:&quot;&quot;},&quot;state&quot;:&quot;connected&quot;}]},&quot;state&quot;:&quot;run&quot;}}
</code></pre>
<p>The raw data might come in useful in some cases.</p>
<p>Happy hacking!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
